<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Kopfrechnen ‚Äì Addition & Multiplikation</title>
  <style>
    :root{
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      --text:#0f172a;
      --muted:#475569;
      --card:#ffffffcc; /* leicht transparent */
      --line:#d1d5db;

      --blue:#2563eb;
      --green:#16a34a;
      --red:#dc2626;
      --yellow:#f59e0b;
      --purple:#7c3aed;
      --pink:#db2777;
      --teal:#0ea5e9;

      --shadow: 0 12px 30px rgba(2,6,23,0.10);
      --star:#facc15;
    }

    /* Sanfter Hintergrund (Pastell) */
    body{
      margin:0;
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:14px;
      color:var(--text);
      background:
        radial-gradient(900px 600px at 10% 20%, #e0f2fe 0%, transparent 60%),
        radial-gradient(900px 600px at 90% 30%, #fce7f3 0%, transparent 60%),
        radial-gradient(900px 600px at 60% 90%, #dcfce7 0%, transparent 60%),
        linear-gradient(135deg, #f8fafc 0%, #eef2ff 50%, #fdf2f8 100%);
    }

    .app{
      width:min(980px, 100%);
      background:var(--card);
      border:2px solid rgba(255,255,255,0.65);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      border-radius:22px;
      box-shadow:var(--shadow);
      padding:16px 18px;
      box-sizing:border-box;
    }
    @media (min-width: 820px){
      .app{ padding:18px 22px; }
    }

    /* Header */
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }
    .titleWrap{
      display:flex;
      align-items:center;
      gap:10px;
    }
    h1{
      margin:0;
      font-size:1.35rem;
      line-height:1.1;
      font-weight:1100;
      letter-spacing:0.2px;
    }
    .infoBtn{
      width:42px;
      height:42px;
      border-radius:999px;
      border:2px solid rgba(37,99,235,0.25);
      background: rgba(37,99,235,0.12);
      color: var(--blue);
      font-weight:1100;
      font-size:1.15rem;
      cursor:pointer;
      display:grid;
      place-items:center;
      user-select:none;
      touch-action: manipulation;
      transition: transform 0.05s ease, background 0.15s ease;
    }
    .infoBtn:active{ transform: translateY(1px); }
    .infoBtn.on{
      background: rgba(37,99,235,0.20);
      border-color: rgba(37,99,235,0.35);
    }

    /* Wenig Text ‚Äì nur wenn Info AN */
    .help{
      margin:6px 0 12px;
      color:var(--muted);
      font-size:0.98rem;
      line-height:1.25;
    }
    .hidden{ display:none !important; }

    /* Layout */
    .grid{ display:grid; gap:10px; }
    .grid.two{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
    .grid.three{ grid-template-columns: repeat(3, minmax(0, 1fr)); }
    @media (max-width: 640px){
      .grid.two, .grid.three{ grid-template-columns: 1fr; }
    }

    .card{
      border:2px solid rgba(15,23,42,0.08);
      border-radius:20px;
      padding:12px;
      background: rgba(255,255,255,0.82);
    }

    /* Buttons ‚Äì bunter */
    .btn{
      border:2px solid rgba(15,23,42,0.10);
      border-radius:18px;
      padding:12px 10px;
      font-size:1.05rem;
      font-weight:1000;
      cursor:pointer;
      user-select:none;
      touch-action: manipulation;
      transition: transform 0.05s ease, filter 0.15s ease, box-shadow 0.15s ease, opacity 0.15s ease;
      box-shadow: 0 10px 18px rgba(2,6,23,0.08);
      background: #f9fafb;
    }
    .btn:active{ transform: translateY(1px); }
    .btn.selected{
      outline: 3px solid rgba(255,255,255,0.55);
      filter: saturate(1.15);
      box-shadow: 0 16px 28px rgba(2,6,23,0.12);
    }

    /* Farbschemata */
    .c-blue{ background: linear-gradient(135deg, #dbeafe 0%, #93c5fd 100%); }
    .c-pink{ background: linear-gradient(135deg, #fce7f3 0%, #f9a8d4 100%); }
    .c-green{ background: linear-gradient(135deg, #dcfce7 0%, #86efac 100%); }
    .c-yellow{ background: linear-gradient(135deg, #fef3c7 0%, #fcd34d 100%); }
    .c-purple{ background: linear-gradient(135deg, #ede9fe 0%, #c4b5fd 100%); }
    .c-teal{ background: linear-gradient(135deg, #cffafe 0%, #67e8f9 100%); }

    .primary{
      width:100%;
      border:none;
      border-radius:999px;
      padding:12px 14px;
      font-size:1.18rem;
      font-weight:1100;
      color:white;
      background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
      box-shadow: 0 18px 30px rgba(37,99,235,0.22);
    }
    .primary:disabled{
      opacity:0.55;
      cursor:not-allowed;
      box-shadow:none;
    }
    .ghost{
      width:100%;
      border-radius:999px;
      padding:11px 14px;
      font-weight:1000;
      background: rgba(255,255,255,0.75);
      box-shadow:none;
    }

    .rowNote{
      text-align:center;
      font-weight:900;
      color:var(--muted);
      min-height:1.2rem;
      margin-top:6px;
    }

    /* Zeit-Buttons */
    .pillrow{ display:flex; flex-wrap:wrap; gap:10px; }
    .pill{
      display:inline-flex;
      gap:8px;
      align-items:center;
      border:2px solid rgba(15,23,42,0.10);
      background: rgba(255,255,255,0.80);
      border-radius:999px;
      padding:10px 12px;
      cursor:pointer;
      font-weight:1100;
      user-select:none;
      touch-action: manipulation;
      box-shadow: 0 10px 18px rgba(2,6,23,0.06);
    }
    .pill.selected{
      border-color: rgba(14,165,233,0.35);
      background: rgba(14,165,233,0.14);
    }
    .icon{
      width:22px; height:22px;
      display:inline-grid; place-items:center;
      border-radius:999px;
      background: rgba(15,23,42,0.08);
      font-size:14px;
    }

    /* Quiz */
    .quiz-layout{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
    }
    @media (min-width: 820px){
      .quiz-layout{
        grid-template-columns: 1.05fr 0.95fr;
        align-items:start;
      }
    }

    .tag{
      display:inline-block;
      border-radius:999px;
      padding:4px 10px;
      font-size:0.92rem;
      font-weight:1100;
      background: rgba(37,99,235,0.12);
      color: #1d4ed8;
    }
    .mini{
      font-size:0.95rem;
      color:var(--muted);
      font-weight:1000;
      white-space:nowrap;
    }

    .equation{
      font-size: clamp(2.4rem, 4.2vw, 3.2rem);
      font-weight:1200;
      text-align:center;
      margin:10px 0 4px;
      letter-spacing: 0.5px;
    }

    /* Timer */
    .timerWrap{
      margin-top:8px;
      height:16px;
      background: rgba(15,23,42,0.08);
      border-radius:999px;
      overflow:hidden;
      border:2px solid rgba(15,23,42,0.10);
    }
    .timerBar{
      height:100%;
      width:100%;
      border-radius:999px;
      transition: width 0.08s linear;
    }

    /* MC */
    .options{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap:10px;
      margin-top:10px;
    }
    .opt{
      border:2px solid rgba(15,23,42,0.10);
      background: rgba(255,255,255,0.75);
      border-radius:18px;
      padding:14px 10px;
      font-size:1.45rem;
      font-weight:1200;
      cursor:pointer;
      user-select:none;
      touch-action: manipulation;
      box-shadow: 0 10px 18px rgba(2,6,23,0.06);
      transition: transform 0.05s ease, filter 0.15s ease;
    }
    .opt:hover{ filter: brightness(0.98) saturate(1.05); }
    .opt:active{ transform: translateY(1px); }
    .opt.disabled{ opacity:0.6; cursor:not-allowed; }

    /* Feedback */
    .feedback{
      min-height:1.4rem;
      text-align:center;
      font-weight:1200;
      margin-top:8px;
      font-size:1.08rem;
    }
    .feedback.ok{ color:var(--green); }
    .feedback.bad{ color:var(--red); }

    /* Score scale */
    .scoreWrap{ margin-top:10px; }
    .scoreTitle{
      display:flex; justify-content:space-between; align-items:center;
      font-weight:1100; color:var(--muted); font-size:0.95rem;
      margin-bottom:6px;
    }
    .scale{
      position:relative;
      height:16px;
      border-radius:999px;
      border:2px solid rgba(15,23,42,0.10);
      background: linear-gradient(90deg, rgba(220,38,38,0.16) 0%, rgba(15,23,42,0.06) 50%, rgba(22,163,74,0.18) 100%);
      overflow:hidden;
    }
    .midline{
      position:absolute;
      left:50%; top:0; width:3px; height:100%;
      background: rgba(100,116,139,0.8);
      transform: translateX(-50%);
    }
    .dot{
      position:absolute;
      top:50%;
      width:18px; height:18px;
      border-radius:999px;
      background:#0f172a;
      transform: translate(-50%, -50%);
      box-shadow: 0 10px 18px rgba(2,6,23,0.18);
      border:2px solid rgba(255,255,255,0.9);
    }
    .scaleLabels{
      display:flex; justify-content:space-between;
      font-size:0.9rem; color:var(--muted); font-weight:1100;
      margin-top:6px;
    }

    /* Scoreboard */
    .scoreboard{
      display:flex;
      gap:10px;
      align-items:stretch;
      justify-content:space-between;
      margin-top:10px;
    }
    .scoreBox{
      flex:1;
      border:2px solid rgba(15,23,42,0.10);
      background: rgba(255,255,255,0.75);
      border-radius:18px;
      padding:10px;
      text-align:center;
      box-shadow: 0 10px 18px rgba(2,6,23,0.06);
    }
    .scoreBox .label{ color:var(--muted); font-weight:1100; font-size:0.95rem; }
    .scoreBox .num{ font-size:2.05rem; font-weight:1300; margin-top:2px; }

    /* Keypad */
    .answerLine{
      display:flex;
      gap:10px;
      align-items:stretch;
      margin-top:10px;
    }
    .answerDisplay{
      flex:1;
      border:2px solid rgba(15,23,42,0.10);
      border-radius:18px;
      background: rgba(255,255,255,0.75);
      padding:12px;
      font-size:1.7rem;
      font-weight:1300;
      text-align:center;
      letter-spacing:2px;
      user-select:none;
      min-height:52px;
      display:flex;
      align-items:center;
      justify-content:center;
      box-shadow: 0 10px 18px rgba(2,6,23,0.06);
    }
    .submitBtn{
      width:130px;
      border:none;
      border-radius:18px;
      background: linear-gradient(135deg, #16a34a 0%, #15803d 100%);
      color:white;
      font-weight:1300;
      font-size:1.12rem;
      cursor:pointer;
      user-select:none;
      touch-action: manipulation;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      box-shadow: 0 16px 26px rgba(21,128,61,0.22);
      transition: transform 0.05s ease, opacity 0.15s ease;
    }
    .submitBtn:active{ transform: translateY(1px); }
    .submitBtn:disabled{ opacity:0.55; cursor:not-allowed; box-shadow:none; }
    .submitIcon{
      width:22px; height:22px;
      border-radius:999px;
      background: rgba(255,255,255,0.25);
      display:grid; place-items:center;
      font-size:14px;
    }
    .keypad{
      margin-top:10px;
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap:10px;
    }
    .key{
      border:2px solid rgba(15,23,42,0.10);
      background: rgba(255,255,255,0.75);
      border-radius:18px;
      padding:14px 10px;
      font-size:1.6rem;
      font-weight:1300;
      cursor:pointer;
      user-select:none;
      touch-action: manipulation;
      box-shadow: 0 10px 18px rgba(2,6,23,0.06);
      transition: transform 0.05s ease;
    }
    .key:active{ transform: translateY(1px); }
    .key.small{ font-size:1.2rem; }

    .stars{
      display:inline-flex; gap:2px;
      margin-right:6px;
      vertical-align:middle;
    }
    .star{
      color:var(--star);
      text-shadow: 0 1px 0 rgba(0,0,0,0.15);
      font-size:1.05em;
      line-height:1;
    }
  </style>
</head>
<body>
<div class="app">
  <div class="topbar">
    <div class="titleWrap">
      <h1>Kopfrechnen</h1>
      <button class="infoBtn on" id="infoBtn" title="Info ein/aus">i</button>
    </div>
    <div class="mini" id="topMini">Addition & Multiplikation</div>
  </div>

  <div class="help" id="helpText">
    1) W√§hle <strong>Training</strong> oder <strong>Wettkampf</strong>.<br>
    2) W√§hle die <strong>Zeit</strong> (nur im Wettkampf).<br>
    3) W√§hle die <strong>Sterne</strong>. Los!
  </div>

  <!-- START -->
  <div id="start">
    <div class="grid two">
      <div class="card">
        <div style="font-weight:1200; margin-bottom:8px;">Modus</div>
        <div class="grid two">
          <button class="btn c-teal modeBtn" data-mode="train">Training</button>
          <button class="btn c-purple modeBtn" data-mode="battle">Wettkampf</button>
        </div>

        <div id="battleSettings" class="hidden" style="margin-top:10px;">
          <div style="font-weight:1200; margin-bottom:8px;">Spiel</div>
          <div class="grid three">
            <button class="btn c-yellow matchBtn" data-match="5">Kurz</button>
            <button class="btn c-pink matchBtn" data-match="7">Mittel</button>
            <button class="btn c-blue matchBtn" data-match="9">Lang</button>
          </div>
        </div>
      </div>

      <div class="card">
        <div style="font-weight:1200; margin-bottom:8px;">Zeit</div>
        <div class="pillrow" id="timeRow">
          <div class="pill timeBtn" data-time="3"><span class="icon">‚è±Ô∏è</span>3 s</div>
          <div class="pill timeBtn" data-time="5"><span class="icon">‚è±Ô∏è</span>5 s</div>
          <div class="pill timeBtn" data-time="10"><span class="icon">‚è±Ô∏è</span>10 s</div>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:10px;">
      <div style="font-weight:1200; margin-bottom:8px;">Sterne</div>
      <div class="grid two">
        <button class="btn c-green diffBtn" data-diff="1">
          <span class="stars"><span class="star">‚òÖ</span></span>
          1 Stern
        </button>
        <button class="btn c-yellow diffBtn" data-diff="2">
          <span class="stars"><span class="star">‚òÖ</span><span class="star">‚òÖ</span></span>
          2 Sterne
        </button>
        <button class="btn c-blue diffBtn" data-diff="3">
          <span class="stars"><span class="star">‚òÖ</span><span class="star">‚òÖ</span><span class="star">‚òÖ</span></span>
          3 Sterne
        </button>
        <button class="btn c-pink diffBtn" data-diff="4">
          <span class="stars"><span class="star">‚òÖ</span><span class="star">‚òÖ</span><span class="star">‚òÖ</span><span class="star">‚òÖ</span></span>
          4 Sterne
        </button>
      </div>

      <div class="rowNote" id="startInfo">Bitte w√§hlen.</div>

      <button class="btn primary" id="startBtn" disabled>Los! üöÄ</button>
      <button class="btn ghost" id="resetBtn">Reset</button>
    </div>
  </div>

  <!-- QUIZ -->
  <div id="quiz" class="hidden">
    <div class="quiz-layout">

      <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
          <div class="tag" id="modeTag">‚Äî</div>
          <div class="mini" id="taskCounter">Aufgabe</div>
        </div>

        <div class="equation" id="eq">__</div>

        <div id="timerArea" class="hidden">
          <div class="timerWrap" aria-label="Zeitbalken">
            <div class="timerBar" id="timerBar"></div>
          </div>
        </div>

        <div id="mcArea" class="options hidden"></div>

        <div id="keypadArea" class="hidden">
          <div class="answerLine">
            <div class="answerDisplay" id="answerDisplay">‚Äî</div>
            <button class="submitBtn" id="submitBtn" disabled>
              <span class="submitIcon">‚úì</span> OK
            </button>
          </div>
          <div class="keypad" id="keypad"></div>
        </div>

        <div class="feedback" id="fb"></div>

        <div style="display:flex; gap:10px; margin-top:10px;">
          <button class="btn ghost" id="quitBtn">Men√º</button>
        </div>
      </div>

      <div class="card">
        <div style="font-weight:1200;">Anzeige</div>

        <div class="scoreboard hidden" id="battleBoard">
          <div class="scoreBox">
            <div class="label">DU</div>
            <div class="num" id="roundsYou">0</div>
          </div>
          <div class="scoreBox">
            <div class="label">RUNDE</div>
            <div class="num" id="roundNo">1</div>
          </div>
          <div class="scoreBox">
            <div class="label">PC</div>
            <div class="num" id="roundsPc">0</div>
          </div>
        </div>

        <div class="scoreWrap">
          <div class="scoreTitle">
            <span>Punkte</span>
            <span id="scoreText">0</span>
          </div>
          <div class="scale">
            <div class="midline"></div>
            <div class="dot" id="scoreDot" style="left:50%;"></div>
          </div>
          <div class="scaleLabels">
            <span>-5</span><span>0</span><span>+5</span>
          </div>
        </div>

        <div class="card" style="margin-top:10px; background: rgba(255,255,255,0.55);">
          <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
            <div style="font-weight:1200;">Richtig</div>
            <div class="tag" id="diffTag">‚Äî</div>
          </div>
          <div style="margin-top:8px; font-weight:1200;">
            <span id="sRight">0</span> / <span id="sTotal">0</span>
          </div>
          <div style="margin-top:4px; color:var(--muted); font-weight:1100;">
            <span id="sPct">0%</span>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- RESULT -->
  <div id="result" class="hidden">
    <div class="card" style="text-align:center;">
      <h2 style="margin:0 0 6px;">Fertig! üéâ</h2>
      <p id="summary" style="margin:0; font-weight:1100;"></p>
      <p style="margin:10px 0 0; color:var(--muted); font-weight:1000;">
        <strong><span id="summaryPct">0%</span></strong>
      </p>

      <div style="margin-top:12px;" class="grid two">
        <button class="btn primary" id="playAgainBtn">Nochmal</button>
        <button class="btn ghost" id="backBtn">Men√º</button>
      </div>
    </div>
  </div>
</div>

<script>
/* =========================
   Audio
   ========================= */
const AUDIO = {
  correct: new Audio('audio/correct.wav'),
  error: new Audio('audio/error.wav'),
  roundwon: new Audio('audio/roundwon.wav'),
  roundlost: new Audio('audio/roundlost.wav'),
  gamewon: new Audio('audio/gamewon.wav'),
  gamelost: new Audio('audio/gamelost.wav'),
};
function playSound(key){
  const a = AUDIO[key];
  if(!a) return;
  try{ a.currentTime=0; a.play().catch(()=>{}); }catch(e){}
}

/* =========================
   State
   ========================= */
let mode = null;            // 'train' | 'battle'
let matchBestOf = 5;        // 5|7|9
let answerTime = 5;         // 3|5|10
let diff = null;            // 1..4

let totalTasks = 0;
let correctCount = 0;

let current = null;         // {text, correct, answerType, options?}
let locked = false;

let timerOn = false;
let timerId = null;
let timerStart = 0;
let timerLimitMs = 0;

let score = 0;
let roundsYou = 0;
let roundsPc = 0;
let roundNo = 1;

const TRAIN_TOTAL = 20;

/* =========================
   DOM
   ========================= */
const startEl = document.getElementById('start');
const quizEl = document.getElementById('quiz');
const resultEl = document.getElementById('result');

const startInfo = document.getElementById('startInfo');
const startBtn = document.getElementById('startBtn');
const resetBtn = document.getElementById('resetBtn');
const battleSettings = document.getElementById('battleSettings');

const modeTag = document.getElementById('modeTag');
const diffTag = document.getElementById('diffTag');
const taskCounter = document.getElementById('taskCounter');
const eq = document.getElementById('eq');

const timerArea = document.getElementById('timerArea');
const timerBar = document.getElementById('timerBar');

const mcArea = document.getElementById('mcArea');
const keypadArea = document.getElementById('keypadArea');
const keypad = document.getElementById('keypad');
const answerDisplay = document.getElementById('answerDisplay');
const submitBtn = document.getElementById('submitBtn');

const fb = document.getElementById('fb');
const quitBtn = document.getElementById('quitBtn');

const battleBoard = document.getElementById('battleBoard');
const roundsYouEl = document.getElementById('roundsYou');
const roundsPcEl = document.getElementById('roundsPc');
const roundNoEl = document.getElementById('roundNo');

const scoreText = document.getElementById('scoreText');
const scoreDot = document.getElementById('scoreDot');

const sRight = document.getElementById('sRight');
const sTotal = document.getElementById('sTotal');
const sPct = document.getElementById('sPct');

const summary = document.getElementById('summary');
const summaryPct = document.getElementById('summaryPct');
const playAgainBtn = document.getElementById('playAgainBtn');
const backBtn = document.getElementById('backBtn');

/* Info toggle */
const infoBtn = document.getElementById('infoBtn');
const helpText = document.getElementById('helpText');
let showHelp = true;
infoBtn.addEventListener('click', ()=>{
  showHelp = !showHelp;
  helpText.classList.toggle('hidden', !showHelp);
  infoBtn.classList.toggle('on', showHelp);
});

/* =========================
   Start selection handlers
   ========================= */
function setSelected(groupSelector, selectedEl){
  document.querySelectorAll(groupSelector).forEach(el => el.classList.remove('selected'));
  if(selectedEl) selectedEl.classList.add('selected');
}

document.querySelectorAll('.modeBtn').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    mode = btn.dataset.mode;
    setSelected('.modeBtn', btn);
    battleSettings.classList.toggle('hidden', mode !== 'battle');
    updateStartReady();
  });
});

document.querySelectorAll('.matchBtn').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    matchBestOf = parseInt(btn.dataset.match, 10);
    setSelected('.matchBtn', btn);
    updateStartReady();
  });
});

document.querySelectorAll('.timeBtn').forEach(pill=>{
  pill.addEventListener('click', ()=>{
    answerTime = parseInt(pill.dataset.time, 10);
    document.querySelectorAll('.timeBtn').forEach(x=>x.classList.remove('selected'));
    pill.classList.add('selected');
    updateStartReady();
  });
});

document.querySelectorAll('.diffBtn').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    diff = parseInt(btn.dataset.diff, 10);
    setSelected('.diffBtn', btn);
    updateStartReady();
  });
});

resetBtn.addEventListener('click', ()=>{
  mode = null; diff = null; answerTime = 5; matchBestOf = 5;
  document.querySelectorAll('.modeBtn,.matchBtn,.timeBtn,.diffBtn').forEach(x=>x.classList.remove('selected'));
  document.querySelectorAll('.timeBtn').forEach(x=>{
    if(parseInt(x.dataset.time,10)===5) x.classList.add('selected');
  });
  battleSettings.classList.add('hidden');
  updateStartReady();
});

/* Default: 5s ausgew√§hlt */
(function init(){
  document.querySelectorAll('.timeBtn').forEach(x=>{
    if(parseInt(x.dataset.time,10)===5) x.classList.add('selected');
  });
  buildKeypad();
  setScoreDot(0);
  updateStartReady();
})();

function diffLabel(d){
  if(d===1) return "‚òÖ";
  if(d===2) return "‚òÖ‚òÖ";
  if(d===3) return "‚òÖ‚òÖ‚òÖ";
  return "‚òÖ‚òÖ‚òÖ‚òÖ";
}

function updateStartReady(){
  let missing = [];
  if(!mode) missing.push("Modus");
  if(!diff) missing.push("Sterne");
  if(missing.length){
    startInfo.textContent = "Bitte w√§hlen: " + missing.join(", ");
    startBtn.disabled = true;
    return;
  }
  startInfo.textContent = "Bereit!";
  startBtn.disabled = false;
}

/* =========================
   Navigation
   ========================= */
startBtn.addEventListener('click', startGame);
quitBtn.addEventListener('click', ()=>{
  stopTimer();
  showScreen('start');
});
playAgainBtn.addEventListener('click', ()=> showScreen('start'));
backBtn.addEventListener('click', ()=> showScreen('start'));

function showScreen(which){
  startEl.classList.toggle('hidden', which!=='start');
  quizEl.classList.toggle('hidden', which!=='quiz');
  resultEl.classList.toggle('hidden', which!=='result');
}

/* =========================
   Game flow
   ========================= */
function startGame(){
  correctCount = 0;
  totalTasks = 0;
  locked = false;
  fb.textContent = '';
  fb.className = 'feedback';

  if(mode === 'battle'){
    roundsYou = 0; roundsPc = 0; roundNo = 1; score = 0;
    battleBoard.classList.remove('hidden');
    roundsYouEl.textContent = '0';
    roundsPcEl.textContent = '0';
    roundNoEl.textContent = '1';
  } else {
    battleBoard.classList.add('hidden');
    score = 0;
  }

  updateStats();
  updateScoreUI();

  modeTag.textContent = (mode==='train') ? 'Training' : 'Wettkampf';
  diffTag.textContent = diffLabel(diff);

  showScreen('quiz');
  nextTask();
}

function nextTask(){
  stopTimer();
  locked = false;
  fb.textContent = '';
  fb.className = 'feedback';

  if(mode === 'train' && totalTasks >= TRAIN_TOTAL){
    endSession();
    return;
  }

  current = generateTask(diff);
  eq.textContent = current.text;

  if(mode === 'train'){
    taskCounter.textContent = `Aufgabe ${totalTasks+1}/${TRAIN_TOTAL}`;
  } else {
    taskCounter.textContent = `Runde ${roundNo}`;
  }

  if(current.answerType === 'mc'){
    keypadArea.classList.add('hidden');
    mcArea.classList.remove('hidden');
    renderMC(current.options);
  } else {
    mcArea.classList.add('hidden');
    keypadArea.classList.remove('hidden');
    resetAnswerInput();
  }

  if(mode === 'battle'){
    timerArea.classList.remove('hidden');
    startTimer(answerTime);
  } else {
    timerArea.classList.add('hidden');
  }
}

function endSession(finalSoundKey){
  stopTimer();
  if(finalSoundKey) playSound(finalSoundKey);

  const pct = totalTasks ? Math.round((correctCount/totalTasks)*100) : 0;
  summary.textContent = `${correctCount} / ${totalTasks}`;
  summaryPct.textContent = `${pct}%`;
  showScreen('result');
}

/* =========================
   Timer
   ========================= */
function startTimer(seconds){
  timerOn = true;
  timerStart = performance.now();
  timerLimitMs = seconds * 1000;

  timerBar.style.width = '100%';
  timerBar.style.background = '#16a34a';
  timerId = requestAnimationFrame(tickTimer);
}
function tickTimer(now){
  if(!timerOn) return;
  const elapsed = now - timerStart;
  const left = Math.max(0, timerLimitMs - elapsed);
  const ratio = left / timerLimitMs;

  timerBar.style.width = (ratio*100).toFixed(1) + '%';

  if(ratio > 0.55) timerBar.style.background = '#16a34a';
  else if(ratio > 0.25) timerBar.style.background = '#f59e0b';
  else timerBar.style.background = '#dc2626';

  if(left <= 0){
    timerOn = false;
    onAnswer(null, {timeout:true});
    return;
  }
  timerId = requestAnimationFrame(tickTimer);
}
function stopTimer(){
  timerOn = false;
  if(timerId){
    cancelAnimationFrame(timerId);
    timerId = null;
  }
}

/* =========================
   Answer handling
   ========================= */
function onAnswer(value, meta={}){
  if(locked) return;
  locked = true;
  stopTimer();

  totalTasks++;
  const isCorrect = (value !== null && value === current.correct);

  if(isCorrect){
    correctCount++;
    fb.textContent = 'Richtig!';
    fb.className = 'feedback ok';
    playSound('correct');
  } else {
    fb.textContent = meta.timeout ? 'Zeit!' : 'Falsch!';
    fb.className = 'feedback bad';
    playSound('error');
  }

  updateStats();

  if(mode === 'battle'){
    score += isCorrect ? 1 : -1;
    score = clamp(score, -5, 5);
    updateScoreUI();

    if(score >= 5){
      roundsYou++;
      roundsYouEl.textContent = String(roundsYou);
      playSound('roundwon');
      if(isMatchFinished()){
        playSound('gamewon');
        setTimeout(()=>endSession(), 520);
        return;
      }
      roundNo++;
      roundNoEl.textContent = String(roundNo);
      score = 0;
      updateScoreUI();
    } else if(score <= -5){
      roundsPc++;
      roundsPcEl.textContent = String(roundsPc);
      playSound('roundlost');
      if(isMatchFinished()){
        playSound('gamelost');
        setTimeout(()=>endSession(), 520);
        return;
      }
      roundNo++;
      roundNoEl.textContent = String(roundNo);
      score = 0;
      updateScoreUI();
    }
  }

  setTimeout(()=> nextTask(), 420);
}
function isMatchFinished(){
  const need = Math.floor(matchBestOf/2) + 1;
  return (roundsYou >= need || roundsPc >= need);
}

/* =========================
   MC rendering
   ========================= */
function renderMC(options){
  mcArea.innerHTML = '';
  options.forEach(v=>{
    const b = document.createElement('button');
    b.className = 'opt';
    b.type = 'button';
    b.textContent = String(v);
    b.addEventListener('click', ()=> onAnswer(v));
    mcArea.appendChild(b);
  });
}

/* =========================
   Keypad
   ========================= */
let typed = '';
function buildKeypad(){
  const keys = ['1','2','3','4','5','6','7','8','9','‚å´','0','C'];
  keypad.innerHTML = '';
  keys.forEach(k=>{
    const b = document.createElement('button');
    b.type = 'button';
    b.className = 'key' + ((k==='‚å´'||k==='C') ? ' small' : '');
    b.textContent = k;
    b.addEventListener('click', ()=>pressKey(k));
    keypad.appendChild(b);
  });
}
function resetAnswerInput(){
  typed = '';
  answerDisplay.textContent = '‚Äî';
  submitBtn.disabled = true;
}
function pressKey(k){
  if(locked) return;
  if(k === 'C'){
    typed = '';
  } else if(k === '‚å´'){
    typed = typed.slice(0, -1);
  } else {
    if(typed.length >= 3) return;
    if(typed === '0') typed = '';
    typed += k;
  }
  answerDisplay.textContent = typed.length ? typed : '‚Äî';
  submitBtn.disabled = (typed.length === 0);
}
submitBtn.addEventListener('click', ()=>{
  if(typed.length === 0) return;
  onAnswer(parseInt(typed, 10));
});

/* =========================
   Generator (WICHTIG: diff 1&2 NUR ADDITION)
   ========================= */
function generateTask(d){
  if(d === 1) return genEasyNoCarryMC();      // NUR +
  if(d === 2) return genMediumCarryMC();      // NUR +
  if(d === 3) return genHardTensKeypad();     // + oder √ó
  return genVeryHardKeypad();                // + oder √ó
}

/* 1 Stern: 0..20 ohne Zehner√ºbergang, MC */
function genEasyNoCarryMC(){
  let a,b,correct;
  while(true){
    a = randInt(0, 20);
    b = randInt(0, 20);
    if((a%10) + (b%10) <= 9 && a + b <= 20){
      correct = a + b;
      break;
    }
  }
  const text = `${a} + ${b} = ?`;
  const options = makeMCOptions(correct, 4, 0, 40);
  return {text, correct, answerType:'mc', options};
}

/* 2 Sterne: 0..20 mit Zehner√ºbergang, MC */
function genMediumCarryMC(){
  let a,b,correct;
  while(true){
    a = randInt(0, 20);
    b = randInt(0, 20);
    const sum = a + b;
    if((a%10) + (b%10) >= 10 && sum <= 20){
      correct = sum;
      break;
    }
  }
  const text = `${a} + ${b} = ?`;
  const options = makeMCOptions(correct, 4, 0, 40);
  return {text, correct, answerType:'mc', options};
}

/* 3 Sterne: bis 100, nur 10er, keypad (+ oder √ó) */
function genHardTensKeypad(){
  const useMul = Math.random() < 0.55;
  let a,b,correct,text;

  if(useMul){
    const tens = [10,20,30,40,50,60,70,80,90,100];
    while(true){
      a = randInt(0, 10);
      b = tens[randInt(0, tens.length-1)];
      correct = a*b;
      if(correct <= 100) break;
    }
    text = `${a} √ó ${b} = ?`;
  } else {
    while(true){
      a = randInt(0, 10)*10;
      b = randInt(0, 10)*10;
      correct = a + b;
      if(correct <= 100) break;
    }
    text = `${a} + ${b} = ?`;
  }
  return {text, correct, answerType:'keypad'};
}

/* 4 Sterne: bis 100, keypad (+ oder √ó) */
function genVeryHardKeypad(){
  const useMul = Math.random() < 0.45;
  let a,b,correct,text;

  if(useMul){
    while(true){
      a = randInt(0, 12);
      b = randInt(0, 12);
      correct = a*b;
      if(correct <= 100) break;
    }
    text = `${a} √ó ${b} = ?`;
  } else {
    while(true){
      a = randInt(0, 100);
      b = randInt(0, 100);
      correct = a+b;
      if(correct <= 100) break;
    }
    text = `${a} + ${b} = ?`;
  }
  return {text, correct, answerType:'keypad'};
}

/* =========================
   Options helper
   ========================= */
function makeMCOptions(correct, count, minV, maxV){
  const set = new Set([correct]);
  const candidates = [];
  [1,2,3,4,5,10].forEach(d=>{
    candidates.push(correct + d, correct - d);
  });
  for(let i=0;i<20;i++){
    const off = randInt(-12,12);
    if(off!==0) candidates.push(correct + off);
  }

  let guard = 0;
  while(set.size < count && guard < 400){
    guard++;
    let c;
    if(Math.random() < 0.75 && candidates.length){
      c = candidates[randInt(0, candidates.length-1)];
    } else {
      c = randInt(minV, maxV);
    }
    if(c < minV || c > maxV) continue;
    set.add(c);
  }

  const arr = Array.from(set);
  for(let i=arr.length-1;i>0;i--){
    const j = randInt(0,i);
    [arr[i],arr[j]] = [arr[j],arr[i]];
  }
  return arr;
}

/* =========================
   UI helpers
   ========================= */
function updateStats(){
  sRight.textContent = String(correctCount);
  sTotal.textContent = String(totalTasks);
  const pct = totalTasks ? Math.round((correctCount/totalTasks)*100) : 0;
  sPct.textContent = pct + '%';
}
function updateScoreUI(){
  scoreText.textContent = String(score);
  setScoreDot(score);
}
function setScoreDot(scoreVal){
  const clamped = clamp(scoreVal, -5, 5);
  const pct = ((clamped + 5) / 10) * 100;
  scoreDot.style.left = pct + '%';
}
function clamp(x, a, b){ return Math.max(a, Math.min(b, x)); }
function randInt(min, max){ return Math.floor(Math.random()*(max-min+1))+min; }
</script>
</body>
</html>
