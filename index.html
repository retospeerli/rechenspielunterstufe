<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Kopfrechnen ‚Äì Addition & Multiplikation (1. Klasse)</title>
  <style>
    :root{
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background:#f3f4f6;
      --card:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --line:#d1d5db;
      --brand:#2563eb;
      --ok:#15803d;
      --bad:#b91c1c;
      --star:#facc15;
      --shadow: 0 10px 30px rgba(0,0,0,0.10);
    }
    body{
      margin:0;
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:14px;
      color:var(--text);
    }
    .app{
      background:var(--card);
      border-radius:20px;
      box-shadow:var(--shadow);
      padding:16px 18px;
      width:min(980px, 100%);
      box-sizing:border-box;
    }

    /* Tablet / Querformat: kompakter, breiter */
    @media (min-width: 820px){
      .app{ padding:18px 22px; }
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:8px;
    }
    h1{
      margin:0;
      font-size:1.25rem;
      line-height:1.1;
    }
    .mini{
      font-size:0.95rem;
      color:var(--muted);
      font-weight:600;
      white-space:nowrap;
    }

    .subtitle{
      margin:6px 0 12px;
      color:var(--muted);
      font-size:0.95rem;
      line-height:1.25;
    }

    .grid{
      display:grid;
      gap:10px;
    }
    .grid.two{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
    .grid.three{ grid-template-columns: repeat(3, minmax(0, 1fr)); }
    @media (max-width: 640px){
      .grid.two, .grid.three{ grid-template-columns: 1fr; }
    }

    .btn{
      border:2px solid var(--line);
      background:#f9fafb;
      border-radius:18px;
      padding:12px 10px;
      font-size:1.05rem;
      font-weight:800;
      cursor:pointer;
      transition: transform 0.05s ease, background 0.15s ease, border-color 0.15s ease, box-shadow 0.15s ease;
      user-select:none;
      touch-action: manipulation;
    }
    .btn:active{ transform: translateY(1px); }
    .btn:hover{ background:#eef2ff; border-color:#a5b4fc; }
    .btn.selected{
      background: var(--brand);
      border-color: #1d4ed8;
      color:white;
      box-shadow: 0 8px 18px rgba(37,99,235,0.30);
    }
    .btn.primary{
      width:100%;
      border:none;
      background: var(--brand);
      color:white;
      border-radius:999px;
      font-size:1.15rem;
      padding:12px 14px;
      font-weight:900;
    }
    .btn.primary:hover{ background:#1d4ed8; }
    .btn.primary:disabled{
      background:#9ca3af;
      cursor:not-allowed;
      box-shadow:none;
    }
    .btn.ghost{
      width:100%;
      border-radius:999px;
      padding:11px 14px;
      font-weight:800;
      background:#f9fafb;
    }

    .pillrow{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      justify-content:flex-start;
      margin-top:10px;
    }
    .pill{
      display:inline-flex;
      gap:8px;
      align-items:center;
      border:2px solid var(--line);
      background:#f9fafb;
      border-radius:999px;
      padding:10px 12px;
      cursor:pointer;
      font-weight:900;
      user-select:none;
      touch-action: manipulation;
    }
    .pill.selected{
      background:#ecfeff;
      border-color:#22d3ee;
      box-shadow: 0 8px 18px rgba(34,211,238,0.15);
    }
    .icon{
      width:22px; height:22px;
      display:inline-grid;
      place-items:center;
      border-radius:999px;
      background:#e5e7eb;
      font-size:14px;
    }
    .pill.selected .icon{ background:#cffafe; }

    .info{
      min-height:1.2rem;
      color:var(--muted);
      font-weight:700;
      text-align:center;
      margin-top:8px;
    }

    .hidden{ display:none !important; }

    /* Quiz */
    .quiz-layout{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
    }
    @media (min-width: 820px){
      .quiz-layout{
        grid-template-columns: 1.05fr 0.95fr;
        align-items:start;
      }
    }

    .card{
      border:2px solid var(--line);
      border-radius:18px;
      padding:12px;
      background:#ffffff;
    }

    .equation{
      font-size: clamp(2.2rem, 4vw, 3.0rem);
      font-weight:1000;
      text-align:center;
      margin:10px 0 4px;
      letter-spacing: 0.5px;
    }

    .tag{
      display:inline-block;
      border-radius:999px;
      padding:4px 10px;
      font-size:0.9rem;
      font-weight:900;
      background:#eff6ff;
      color:#1d4ed8;
      margin:0 auto;
    }

    .options{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap:10px;
      margin-top:10px;
    }
    .opt{
      border:2px solid var(--line);
      background:#f9fafb;
      border-radius:18px;
      padding:14px 10px;
      font-size:1.35rem;
      font-weight:1000;
      cursor:pointer;
      transition: transform 0.05s ease, background 0.15s ease, border-color 0.15s ease, box-shadow 0.15s ease;
      user-select:none;
      touch-action: manipulation;
    }
    .opt:hover{ background:#e5e7eb; }
    .opt:active{ transform: translateY(1px); }
    .opt.disabled{
      opacity:0.6;
      cursor:not-allowed;
    }

    .feedback{
      min-height:1.4rem;
      text-align:center;
      font-weight:1000;
      margin-top:8px;
      font-size:1.05rem;
    }
    .feedback.ok{ color:var(--ok); }
    .feedback.bad{ color:var(--bad); }

    /* Timer bar */
    .timerWrap{
      margin-top:8px;
      height:16px;
      background:#e5e7eb;
      border-radius:999px;
      overflow:hidden;
      border:2px solid var(--line);
    }
    .timerBar{
      height:100%;
      width:100%;
      border-radius:999px;
      transition: width 0.08s linear;
    }

    /* Score scale -5 .. +5 with dot */
    .scoreWrap{
      margin-top:10px;
    }
    .scoreTitle{
      display:flex;
      justify-content:space-between;
      align-items:center;
      font-weight:1000;
      color:var(--muted);
      font-size:0.95rem;
      margin-bottom:6px;
    }
    .scale{
      position:relative;
      height:16px;
      border-radius:999px;
      border:2px solid var(--line);
      background: linear-gradient(90deg, #fee2e2 0%, #f3f4f6 50%, #dcfce7 100%);
      overflow:hidden;
    }
    .midline{
      position:absolute;
      left:50%;
      top:0;
      width:3px;
      height:100%;
      background:#9ca3af;
      opacity:0.7;
      transform: translateX(-50%);
    }
    .dot{
      position:absolute;
      top:50%;
      width:18px;
      height:18px;
      border-radius:999px;
      background:#111827;
      transform: translate(-50%, -50%);
      box-shadow: 0 6px 14px rgba(0,0,0,0.20);
      border:2px solid #ffffff;
    }
    .scaleLabels{
      display:flex;
      justify-content:space-between;
      font-size:0.9rem;
      color:var(--muted);
      font-weight:900;
      margin-top:6px;
    }

    /* Scoreboard */
    .scoreboard{
      display:flex;
      gap:10px;
      align-items:stretch;
      justify-content:space-between;
      margin-top:10px;
    }
    .scoreBox{
      flex:1;
      border:2px solid var(--line);
      background:#f9fafb;
      border-radius:18px;
      padding:10px;
      text-align:center;
    }
    .scoreBox .label{
      color:var(--muted);
      font-weight:1000;
      font-size:0.95rem;
    }
    .scoreBox .num{
      font-size:2.0rem;
      font-weight:1100;
      margin-top:2px;
    }

    /* Keypad */
    .answerLine{
      display:flex;
      gap:10px;
      align-items:stretch;
      margin-top:10px;
    }
    .answerDisplay{
      flex:1;
      border:2px solid var(--line);
      border-radius:18px;
      background:#f9fafb;
      padding:12px;
      font-size:1.6rem;
      font-weight:1100;
      text-align:center;
      letter-spacing:2px;
      user-select:none;
      min-height:52px;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .submitBtn{
      width:120px;
      border:none;
      border-radius:18px;
      background: var(--ok);
      color:white;
      font-weight:1100;
      font-size:1.1rem;
      cursor:pointer;
      user-select:none;
      touch-action: manipulation;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      box-shadow: 0 10px 20px rgba(21,128,61,0.25);
    }
    .submitBtn:active{ transform: translateY(1px); }
    .submitBtn:disabled{
      background:#9ca3af;
      cursor:not-allowed;
      box-shadow:none;
    }
    .submitIcon{
      width:22px; height:22px;
      border-radius:999px;
      background: rgba(255,255,255,0.25);
      display:grid;
      place-items:center;
      font-size:14px;
    }

    .keypad{
      margin-top:10px;
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap:10px;
    }
    .key{
      border:2px solid var(--line);
      background:#f9fafb;
      border-radius:18px;
      padding:14px 10px;
      font-size:1.55rem;
      font-weight:1100;
      cursor:pointer;
      user-select:none;
      touch-action: manipulation;
    }
    .key:hover{ background:#e5e7eb; }
    .key:active{ transform: translateY(1px); }
    .key.small{ font-size:1.2rem; }

    /* Stars */
    .stars{
      display:inline-flex;
      gap:2px;
      margin-right:6px;
      vertical-align:middle;
    }
    .star{
      color:var(--star);
      text-shadow: 0 1px 0 rgba(0,0,0,0.15);
      font-size:1.05em;
      line-height:1;
    }
  </style>
</head>
<body>
<div class="app">
  <div class="topbar">
    <h1>Kopfrechnen</h1>
    <div class="mini" id="top-mini">Addition & Multiplikation</div>
  </div>

  <!-- START -->
  <div id="start">
    <div class="subtitle">
      W√§hle <strong>Modus</strong>, <strong>Zeit</strong> und <strong>Schwierigkeit</strong>.
      F√ºr die 1. Klasse: grosse Buttons, Tablet-optimiert (Querformat).
    </div>

    <div class="grid two">
      <div class="card">
        <div style="font-weight:1100; margin-bottom:8px;">1) Modus</div>
        <div class="grid two">
          <button class="btn modeBtn" data-mode="train">Training (ohne Zeitdruck)</button>
          <button class="btn modeBtn" data-mode="battle">Wettkampf vs. Computer</button>
        </div>

        <div id="battleSettings" class="hidden" style="margin-top:10px;">
          <div style="font-weight:1100; margin-bottom:8px;">Wettkampf: Spiel-L√§nge</div>
          <div class="grid three">
            <button class="btn matchBtn" data-match="5">Kurz (Best of 5)</button>
            <button class="btn matchBtn" data-match="7">Mittel (Best of 7)</button>
            <button class="btn matchBtn" data-match="9">Lang (Best of 9)</button>
          </div>
          <div class="subtitle" style="margin:8px 0 0;">
            Eine Runde endet bei <strong>+5</strong> (du) oder <strong>-5</strong> (Computer).
          </div>
        </div>
      </div>

      <div class="card">
        <div style="font-weight:1100; margin-bottom:8px;">2) Antwort-Zeit</div>
        <div class="pillrow" id="timeRow">
          <div class="pill timeBtn" data-time="3"><span class="icon">‚è±Ô∏è</span>3 s</div>
          <div class="pill timeBtn" data-time="5"><span class="icon">‚è±Ô∏è</span>5 s</div>
          <div class="pill timeBtn" data-time="10"><span class="icon">‚è±Ô∏è</span>10 s</div>
        </div>
        <div class="subtitle" style="margin:10px 0 0;">
          Im Training wird die Zeit <strong>nicht</strong> runtergez√§hlt ‚Äì im Wettkampf schon.
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:10px;">
      <div style="font-weight:1100; margin-bottom:8px;">3) Schwierigkeit</div>
      <div class="grid two">
        <button class="btn diffBtn" data-diff="1">
          <span class="stars"><span class="star">‚òÖ</span></span>
          Einfach (0‚Äì20, ohne Zehner√ºbergang, MC)
        </button>
        <button class="btn diffBtn" data-diff="2">
          <span class="stars"><span class="star">‚òÖ</span><span class="star">‚òÖ</span></span>
          Mittel (0‚Äì20, mit Zehner√ºbergang, MC)
        </button>
        <button class="btn diffBtn" data-diff="3">
          <span class="stars"><span class="star">‚òÖ</span><span class="star">‚òÖ</span><span class="star">‚òÖ</span></span>
          Schwierig (bis 100, nur 10er, Ziffernblock)
        </button>
        <button class="btn diffBtn" data-diff="4">
          <span class="stars"><span class="star">‚òÖ</span><span class="star">‚òÖ</span><span class="star">‚òÖ</span><span class="star">‚òÖ</span></span>
          Sehr schwierig (bis 100, Ziffernblock)
        </button>
      </div>

      <div class="info" id="startInfo">Bitte alles ausw√§hlen.</div>

      <button class="btn primary" id="startBtn" disabled>Los geht‚Äôs! üöÄ</button>
      <button class="btn ghost" id="resetBtn">Zur√ºcksetzen</button>
    </div>

    <div class="subtitle" style="margin-top:10px;">
      Audio: <code>audio/correct.wav</code>, <code>audio/error.wav</code>, <code>audio/roundwon.wav</code>,
      <code>audio/roundlost.wav</code>, <code>audio/gamewon.wav</code>, <code>audio/gamelost.wav</code>
      (Ordner <code>audio</code> mit <code>.gitkeep</code>).
    </div>
  </div>

  <!-- QUIZ -->
  <div id="quiz" class="hidden">
    <div class="quiz-layout">

      <!-- Left: question -->
      <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
          <div class="tag" id="modeTag">‚Äî</div>
          <div class="mini" id="taskCounter">Aufgabe 1</div>
        </div>

        <div class="equation" id="eq">__</div>

        <!-- timer -->
        <div id="timerArea" class="hidden">
          <div class="timerWrap" aria-label="Zeitbalken">
            <div class="timerBar" id="timerBar"></div>
          </div>
        </div>

        <!-- MC options -->
        <div id="mcArea" class="options hidden"></div>

        <!-- Keypad -->
        <div id="keypadArea" class="hidden">
          <div class="answerLine">
            <div class="answerDisplay" id="answerDisplay">‚Äî</div>
            <button class="submitBtn" id="submitBtn" disabled>
              <span class="submitIcon">‚úì</span> OK
            </button>
          </div>
          <div class="keypad" id="keypad">
            <!-- keys filled by JS -->
          </div>
        </div>

        <div class="feedback" id="fb"></div>

        <div style="display:flex; gap:10px; margin-top:10px;">
          <button class="btn ghost" id="quitBtn">Zur√ºck ins Men√º</button>
          <button class="btn ghost" id="nextBtn" class="hidden">Weiter</button>
        </div>
      </div>

      <!-- Right: stats / scoreboard -->
      <div class="card">
        <div style="font-weight:1100;">Anzeige</div>

        <div class="scoreboard" id="battleBoard" class="hidden">
          <div class="scoreBox">
            <div class="label">DU</div>
            <div class="num" id="roundsYou">0</div>
          </div>
          <div class="scoreBox">
            <div class="label">RUNDE</div>
            <div class="num" id="roundNo">1</div>
          </div>
          <div class="scoreBox">
            <div class="label">PC</div>
            <div class="num" id="roundsPc">0</div>
          </div>
        </div>

        <div class="scoreWrap" id="scoreWrap">
          <div class="scoreTitle">
            <span>Zwischenstand</span>
            <span id="scoreText">0</span>
          </div>
          <div class="scale">
            <div class="midline"></div>
            <div class="dot" id="scoreDot" style="left:50%;"></div>
          </div>
          <div class="scaleLabels">
            <span>-5 (PC)</span>
            <span>0</span>
            <span>+5 (DU)</span>
          </div>
        </div>

        <div class="card" style="margin-top:10px; background:#f9fafb;">
          <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
            <div style="font-weight:1100;">Trefferquote</div>
            <div class="tag" id="diffTag">‚Äî</div>
          </div>
          <div style="margin-top:8px; font-weight:1000;">
            Richtig: <span id="sRight">0</span> / <span id="sTotal">0</span>
          </div>
          <div style="margin-top:4px; color:var(--muted); font-weight:900;">
            Prozent (f√ºr LP): <span id="sPct">0%</span>
          </div>
        </div>

        <div class="subtitle" style="margin-top:10px;">
          Tipp: Im Wettkampf z√§hlt jede Aufgabe direkt zum Punktestand.
          Bei Zeitablauf z√§hlt es als falsch.
        </div>
      </div>

    </div>
  </div>

  <!-- RESULT -->
  <div id="result" class="hidden">
    <div class="card" style="text-align:center;">
      <h2 style="margin:0 0 6px;">Fertig! üéâ</h2>
      <p id="summary" style="margin:0; font-weight:900;"></p>
      <p style="margin:10px 0 0; color:var(--muted); font-weight:700;">
        Prozent (f√ºr LP): <strong><span id="summaryPct">0%</span></strong>
      </p>

      <div style="margin-top:12px;" class="grid two">
        <button class="btn primary" id="playAgainBtn">Nochmal spielen</button>
        <button class="btn ghost" id="backBtn">Zur√ºck ins Men√º</button>
      </div>
    </div>
  </div>
</div>

<script>
/* =========================
   Kopfrechnen ‚Äì Logik
   ========================= */

const AUDIO = {
  correct: new Audio('audio/correct.wav'),
  error: new Audio('audio/error.wav'),
  roundwon: new Audio('audio/roundwon.wav'),
  roundlost: new Audio('audio/roundlost.wav'),
  gamewon: new Audio('audio/gamewon.wav'),
  gamelost: new Audio('audio/gamelost.wav'),
};

function playSound(key){
  const a = AUDIO[key];
  if(!a) return;
  try{
    a.currentTime = 0;
    a.play().catch(()=>{});
  }catch(e){}
}

/* ----- State ----- */
let mode = null;            // 'train' | 'battle'
let matchBestOf = 5;        // 5|7|9 (nur battle)
let answerTime = 5;         // 3|5|10
let diff = null;            // 1..4

let totalTasks = 0;
let correctCount = 0;

let current = null;         // {a,b,op,correct,text,answerType:'mc'|'keypad', options[]}
let locked = false;

let timerOn = false;
let timerId = null;
let timerStart = 0;
let timerLimitMs = 0;

let score = 0;              // -5..+5 (battle round score)
let roundsYou = 0;
let roundsPc = 0;
let roundNo = 1;

/* Training: wir nehmen eine ‚ÄúSession‚Äù mit fixen Aufgaben */
const TRAIN_TOTAL = 20;     // gut f√ºr Kinder: kurz, motivierend

/* ----- DOM ----- */
const startEl = document.getElementById('start');
const quizEl = document.getElementById('quiz');
const resultEl = document.getElementById('result');

const startInfo = document.getElementById('startInfo');
const startBtn = document.getElementById('startBtn');
const resetBtn = document.getElementById('resetBtn');

const battleSettings = document.getElementById('battleSettings');

const modeTag = document.getElementById('modeTag');
const diffTag = document.getElementById('diffTag');
const taskCounter = document.getElementById('taskCounter');
const eq = document.getElementById('eq');

const timerArea = document.getElementById('timerArea');
const timerBar = document.getElementById('timerBar');

const mcArea = document.getElementById('mcArea');
const keypadArea = document.getElementById('keypadArea');
const keypad = document.getElementById('keypad');
const answerDisplay = document.getElementById('answerDisplay');
const submitBtn = document.getElementById('submitBtn');

const fb = document.getElementById('fb');
const quitBtn = document.getElementById('quitBtn');

const battleBoard = document.getElementById('battleBoard');
const roundsYouEl = document.getElementById('roundsYou');
const roundsPcEl = document.getElementById('roundsPc');
const roundNoEl = document.getElementById('roundNo');

const scoreText = document.getElementById('scoreText');
const scoreDot = document.getElementById('scoreDot');

const sRight = document.getElementById('sRight');
const sTotal = document.getElementById('sTotal');
const sPct = document.getElementById('sPct');

const summary = document.getElementById('summary');
const summaryPct = document.getElementById('summaryPct');
const playAgainBtn = document.getElementById('playAgainBtn');
const backBtn = document.getElementById('backBtn');

function setSelected(groupSelector, selectedEl){
  document.querySelectorAll(groupSelector).forEach(el => el.classList.remove('selected'));
  if(selectedEl) selectedEl.classList.add('selected');
}

/* ----- Start selections ----- */
document.querySelectorAll('.modeBtn').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    mode = btn.dataset.mode;
    setSelected('.modeBtn', btn);
    battleSettings.classList.toggle('hidden', mode !== 'battle');
    updateStartReady();
  });
});

document.querySelectorAll('.matchBtn').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    matchBestOf = parseInt(btn.dataset.match, 10);
    setSelected('.matchBtn', btn);
    updateStartReady();
  });
});

document.querySelectorAll('.timeBtn').forEach(pill=>{
  pill.addEventListener('click', ()=>{
    answerTime = parseInt(pill.dataset.time, 10);
    document.querySelectorAll('.timeBtn').forEach(x=>x.classList.remove('selected'));
    pill.classList.add('selected');
    updateStartReady();
  });
});

document.querySelectorAll('.diffBtn').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    diff = parseInt(btn.dataset.diff, 10);
    setSelected('.diffBtn', btn);
    updateStartReady();
  });
});

resetBtn.addEventListener('click', ()=>{
  mode = null; diff = null; answerTime = 5; matchBestOf = 5;
  document.querySelectorAll('.modeBtn,.matchBtn,.timeBtn,.diffBtn').forEach(x=>x.classList.remove('selected'));
  // default time select 5s
  document.querySelectorAll('.timeBtn').forEach(x=>{
    if(parseInt(x.dataset.time,10)===5) x.classList.add('selected');
  });
  battleSettings.classList.add('hidden');
  updateStartReady();
});

function diffLabel(d){
  const stars = "‚òÖ".repeat(d);
  if(d===1) return `${stars} Einfach`;
  if(d===2) return `${stars} Mittel`;
  if(d===3) return `${stars} Schwierig`;
  return `${stars} Sehr schwierig`;
}

function updateStartReady(){
  let msg = [];
  if(!mode) msg.push("Modus");
  if(!diff) msg.push("Schwierigkeit");
  if(mode === 'battle' && !matchBestOf) msg.push("Spiel-L√§nge");

  if(msg.length){
    startInfo.textContent = "Bitte ausw√§hlen: " + msg.join(", ") + ".";
    startBtn.disabled = true;
    return;
  }

  const timeText = (mode === 'battle') ? `${answerTime}s pro Aufgabe` : `ohne Zeitdruck (Zeitwahl egal)`;
  startInfo.textContent = `Bereit: ${mode==='train'?'Training':'Wettkampf'} ¬∑ ${timeText} ¬∑ ${diffLabel(diff)}`;
  startBtn.disabled = false;
}

/* default time 5s selected */
(function init(){
  document.querySelectorAll('.timeBtn').forEach(x=>{
    if(parseInt(x.dataset.time,10)===5) x.classList.add('selected');
  });
  updateStartReady();
  buildKeypad();
  setScoreDot(0);
})();

/* ----- Navigation ----- */
startBtn.addEventListener('click', startGame);
quitBtn.addEventListener('click', ()=>{
  stopTimer();
  showScreen('start');
});

playAgainBtn.addEventListener('click', ()=>{
  showScreen('start');
});

backBtn.addEventListener('click', ()=>{
  showScreen('start');
});

function showScreen(which){
  startEl.classList.toggle('hidden', which!=='start');
  quizEl.classList.toggle('hidden', which!=='quiz');
  resultEl.classList.toggle('hidden', which!=='result');
}

/* =========================
   Game flow
   ========================= */

function startGame(){
  correctCount = 0;
  totalTasks = 0;
  locked = false;
  fb.textContent = '';
  fb.className = 'feedback';

  if(mode === 'battle'){
    roundsYou = 0; roundsPc = 0; roundNo = 1;
    score = 0;
    battleBoard.classList.remove('hidden');
    roundsYouEl.textContent = '0';
    roundsPcEl.textContent = '0';
    roundNoEl.textContent = '1';
  } else {
    battleBoard.classList.add('hidden');
    score = 0;
  }

  updateStats();
  updateScoreUI();

  modeTag.textContent = (mode==='train') ? 'Training' : `Wettkampf (Best of ${matchBestOf})`;
  diffTag.textContent = diffLabel(diff);

  showScreen('quiz');
  nextTask();
}

function nextTask(){
  stopTimer();
  locked = false;
  fb.textContent = '';
  fb.className = 'feedback';

  // Training endet nach TRAIN_TOTAL Aufgaben
  if(mode === 'train' && totalTasks >= TRAIN_TOTAL){
    endSession();
    return;
  }

  current = generateTask(diff);

  eq.textContent = current.text;

  // Anzeige Task counter
  if(mode === 'train'){
    taskCounter.textContent = `Aufgabe ${totalTasks+1} von ${TRAIN_TOTAL}`;
  } else {
    taskCounter.textContent = `Runde ${roundNo} ¬∑ Aufgabe ${totalTasks+1}`;
  }

  if(current.answerType === 'mc'){
    keypadArea.classList.add('hidden');
    mcArea.classList.remove('hidden');
    renderMC(current.options);
  } else {
    mcArea.classList.add('hidden');
    keypadArea.classList.remove('hidden');
    resetAnswerInput();
  }

  // Timer nur im Wettkampf
  if(mode === 'battle'){
    timerArea.classList.remove('hidden');
    startTimer(answerTime);
  } else {
    timerArea.classList.add('hidden');
  }
}

function endSession(finalSoundKey){
  stopTimer();
  if(finalSoundKey) playSound(finalSoundKey);

  const pct = totalTasks ? Math.round((correctCount/totalTasks)*100) : 0;
  summary.textContent = `Richtig: ${correctCount} von ${totalTasks}.`;
  summaryPct.textContent = `${pct}%`;
  showScreen('result');
}

/* =========================
   Timer
   ========================= */

function startTimer(seconds){
  timerOn = true;
  timerStart = performance.now();
  timerLimitMs = seconds * 1000;

  // initial bar
  timerBar.style.width = '100%';
  timerBar.style.background = '#16a34a'; // gr√ºn
  timerId = requestAnimationFrame(tickTimer);
}

function tickTimer(now){
  if(!timerOn) return;
  const elapsed = now - timerStart;
  const left = Math.max(0, timerLimitMs - elapsed);
  const ratio = left / timerLimitMs;

  timerBar.style.width = (ratio*100).toFixed(1) + '%';

  // farbe: gr√ºn -> gelb -> rot
  if(ratio > 0.55){
    timerBar.style.background = '#16a34a'; // gr√ºn
  } else if(ratio > 0.25){
    timerBar.style.background = '#f59e0b'; // gelb
  } else {
    timerBar.style.background = '#dc2626'; // rot
  }

  if(left <= 0){
    // Time up => z√§hlt als falsch
    timerOn = false;
    onAnswer(null, {timeout:true});
    return;
  }
  timerId = requestAnimationFrame(tickTimer);
}

function stopTimer(){
  timerOn = false;
  if(timerId){
    cancelAnimationFrame(timerId);
    timerId = null;
  }
}

/* =========================
   Answer handling
   ========================= */

function onAnswer(value, meta={}){
  if(locked) return;
  locked = true;
  stopTimer();

  totalTasks++;
  const isCorrect = (value !== null && value === current.correct);

  if(isCorrect){
    correctCount++;
    fb.textContent = 'Richtig! üëç';
    fb.className = 'feedback ok';
    playSound('correct');
  } else {
    fb.textContent = meta.timeout ? 'Zeit abgelaufen! ‚è±Ô∏è' : 'Leider falsch.';
    fb.className = 'feedback bad';
    playSound('error');
  }

  updateStats();

  if(mode === 'battle'){
    // Punkte: richtig => +1 (du), falsch => -1 (PC)
    score += isCorrect ? 1 : -1;
    score = clamp(score, -5, 5);
    updateScoreUI();

    // Round end?
    if(score >= 5){
      roundsYou++;
      roundsYouEl.textContent = String(roundsYou);
      playSound('roundwon');
      if(isMatchFinished()){
        playSound('gamewon');
        setTimeout(()=>endSession(), 550);
        return;
      }
      // n√§chste Runde
      roundNo++;
      roundNoEl.textContent = String(roundNo);
      score = 0;
      updateScoreUI();
    } else if(score <= -5){
      roundsPc++;
      roundsPcEl.textContent = String(roundsPc);
      playSound('roundlost');
      if(isMatchFinished()){
        playSound('gamelost');
        setTimeout(()=>endSession(), 550);
        return;
      }
      roundNo++;
      roundNoEl.textContent = String(roundNo);
      score = 0;
      updateScoreUI();
    }
  }

  // Nach kurzer Pause weiter
  setTimeout(()=>{
    if(current.answerType === 'mc'){
      // buttons wieder aktivieren (neue Aufgabe rendert)
    } else {
      // keypad reset on next task
    }
    nextTask();
  }, 520);
}

function isMatchFinished(){
  // Best of N: wer zuerst > N/2 Runden gewinnt
  const need = Math.floor(matchBestOf/2) + 1;
  return (roundsYou >= need || roundsPc >= need);
}

/* =========================
   MC rendering
   ========================= */

function renderMC(options){
  mcArea.innerHTML = '';
  options.forEach(v=>{
    const b = document.createElement('button');
    b.className = 'opt';
    b.type = 'button';
    b.textContent = String(v);
    b.addEventListener('click', ()=> onAnswer(v));
    mcArea.appendChild(b);
  });
}

/* =========================
   Keypad
   ========================= */

let typed = '';

function buildKeypad(){
  const keys = [
    '1','2','3',
    '4','5','6',
    '7','8','9',
    '‚å´','0','C'
  ];
  keypad.innerHTML = '';
  keys.forEach(k=>{
    const b = document.createElement('button');
    b.type = 'button';
    b.className = 'key' + (k==='‚å´' || k==='C' ? ' small' : '');
    b.textContent = k;
    b.addEventListener('click', ()=>pressKey(k));
    keypad.appendChild(b);
  });
}

function resetAnswerInput(){
  typed = '';
  answerDisplay.textContent = '‚Äî';
  submitBtn.disabled = true;
}

function pressKey(k){
  if(locked) return;
  if(k === 'C'){
    typed = '';
  } else if(k === '‚å´'){
    typed = typed.slice(0, -1);
  } else {
    // max 3 digits reicht f√ºr bis 100
    if(typed.length >= 3) return;
    // Keine f√ºhrenden Nullen aufblasen (aber "0" ist ok)
    if(typed === '0') typed = '';
    typed += k;
  }

  answerDisplay.textContent = typed.length ? typed : '‚Äî';
  submitBtn.disabled = (typed.length === 0);
}

submitBtn.addEventListener('click', ()=>{
  if(typed.length === 0) return;
  const v = parseInt(typed, 10);
  onAnswer(v);
});

/* =========================
   Generator (Addition & Multiplikation)
   ========================= */

function generateTask(d){
  // d=1: 0..20, ohne Zehner√ºbergang, MC (4)
  // d=2: 0..20, mit Zehner√ºbergang, MC (4)
  // d=3: bis 100, nur Vielfache von 10, keypad
  // d=4: bis 100, keypad

  if(d === 1) return genEasyNoCarryMC();
  if(d === 2) return genMediumCarryMC();
  if(d === 3) return genHardTensKeypad();
  return genVeryHardKeypad();
}

function genEasyNoCarryMC(){
  // Addition ohne Zehner√ºbergang ODER Multiplikation, Ergebnis <= 20, ohne ‚ÄúCarry‚Äù
  // F√ºr Kinder: multiplikation nur sehr klein (0..5) und Ergebnis <= 20
  const useMul = Math.random() < 0.35;

  let a,b,op,correct;
  if(useMul){
    op = '√ó';
    while(true){
      a = randInt(0, 5);
      b = randInt(0, 5);
      correct = a*b;
      if(correct <= 20) break;
    }
  } else {
    op = '+';
    while(true){
      a = randInt(0, 20);
      b = randInt(0, 20);
      // ohne Zehner√ºbergang: Einerstellen sum <= 9 und Ergebnis <= 20
      if((a%10) + (b%10) <= 9 && a + b <= 20){
        correct = a + b;
        break;
      }
    }
  }

  const text = `${a} ${op} ${b} = ?`;
  const options = makeMCOptions(correct, 4, 0, 40);

  return {a,b,op,correct,text,answerType:'mc',options};
}

function genMediumCarryMC(){
  // Addition mit Zehner√ºbergang ODER Multiplikation (klein), MC
  const useMul = Math.random() < 0.30;

  let a,b,op,correct;
  if(useMul){
    op = '√ó';
    // etwas anspruchsvoller: 0..10, aber Ergebnis <= 20
    while(true){
      a = randInt(0, 10);
      b = randInt(0, 10);
      correct = a*b;
      if(correct <= 20) break;
    }
  } else {
    op = '+';
    while(true){
      a = randInt(0, 20);
      b = randInt(0, 20);
      const sum = a + b;
      // mit Zehner√ºbergang: Einerstellen sum >= 10, Ergebnis <= 20
      if((a%10) + (b%10) >= 10 && sum <= 20){
        correct = sum;
        break;
      }
    }
  }

  const text = `${a} ${op} ${b} = ?`;
  const options = makeMCOptions(correct, 4, 0, 40);

  return {a,b,op,correct,text,answerType:'mc',options};
}

function genHardTensKeypad(){
  // Bis 100, nur Vielfache von 10: Addition ODER Multiplikation (mit 10er)
  // z.B. 30 + 40, 70 -? (nein, nur add/mul), 6√ó10, 4√ó20
  const useMul = Math.random() < 0.55;
  let a,b,op,correct;

  if(useMul){
    op = '√ó';
    const tens = [10,20,30,40,50,60,70,80,90,100];
    while(true){
      a = randInt(0, 10);                 // 0..10
      b = tens[randInt(0, tens.length-1)];
      correct = a*b;
      if(correct <= 100) break;
    }
  } else {
    op = '+';
    while(true){
      a = randInt(0, 10)*10;
      b = randInt(0, 10)*10;
      correct = a + b;
      if(correct <= 100) break;
    }
  }

  const text = `${a} ${op} ${b} = ?`;
  return {a,b,op,correct,text,answerType:'keypad'};
}

function genVeryHardKeypad(){
  // Bis 100: Addition oder Multiplikation
  const useMul = Math.random() < 0.45;
  let a,b,op,correct;

  if(useMul){
    op='√ó';
    // kindgerecht, aber bis 100: z.B. 0..12 √ó 0..12 (max 144) -> begrenzen auf <=100
    while(true){
      a = randInt(0, 12);
      b = randInt(0, 12);
      correct = a*b;
      if(correct <= 100) break;
    }
  } else {
    op='+';
    while(true){
      a = randInt(0, 100);
      b = randInt(0, 100);
      correct = a+b;
      if(correct <= 100) break;
    }
  }

  const text = `${a} ${op} ${b} = ?`;
  return {a,b,op,correct,text,answerType:'keypad'};
}

/* =========================
   MC options helper
   ========================= */
function makeMCOptions(correct, count, minV, maxV){
  const set = new Set([correct]);
  // kindgerechte Ablenkungen: nahe Werte, +1/-1, +2/-2, +10/-10
  const candidates = [];
  [1,2,3,4,5,10].forEach(d=>{
    candidates.push(correct + d, correct - d);
  });
  // zuf√§llig weitere Offsets
  for(let i=0;i<20;i++){
    const off = randInt(-12,12);
    if(off!==0) candidates.push(correct + off);
  }

  // f√ºllen
  let guard = 0;
  while(set.size < count && guard < 400){
    guard++;
    let c;
    if(Math.random() < 0.75 && candidates.length){
      c = candidates[randInt(0, candidates.length-1)];
    } else {
      c = randInt(minV, maxV);
    }
    if(c < minV || c > maxV) continue;
    set.add(c);
  }

  const arr = Array.from(set);
  // shuffle
  for(let i=arr.length-1;i>0;i--){
    const j = randInt(0,i);
    [arr[i],arr[j]] = [arr[j],arr[i]];
  }
  return arr;
}

/* =========================
   UI helpers
   ========================= */

function updateStats(){
  sRight.textContent = String(correctCount);
  sTotal.textContent = String(totalTasks);
  const pct = totalTasks ? Math.round((correctCount/totalTasks)*100) : 0;
  sPct.textContent = pct + '%';
}

function updateScoreUI(){
  scoreText.textContent = String(score);
  setScoreDot(score);
}

function setScoreDot(scoreVal){
  // map -5..+5 => 0..100
  const clamped = clamp(scoreVal, -5, 5);
  const pct = ((clamped + 5) / 10) * 100;
  scoreDot.style.left = pct + '%';
}

function clamp(x, a, b){ return Math.max(a, Math.min(b, x)); }
function randInt(min, max){ return Math.floor(Math.random()*(max-min+1))+min; }
</script>
</body>
</html>
