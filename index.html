<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Kopfrechnen ‚Äì ZR20 / ZR100</title>
  <style>
    :root{
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      --text:#0f172a;
      --muted:#475569;

      --shadow: 0 12px 30px rgba(2,6,23,0.10);
      --star:#facc15;

      --bg1:#e0f2fe; --bg2:#fce7f3; --bg3:#dcfce7; --bg4:#eef2ff;

      --teal-bg:  linear-gradient(135deg, #cffafe 0%, #67e8f9 100%);
      --teal-br:  rgba(14,165,233,0.35);
      --teal-brD: #0284c7;

      --purple-bg: linear-gradient(135deg, #ede9fe 0%, #c4b5fd 100%);
      --purple-br: rgba(124,58,237,0.35);
      --purple-brD:#5b21b6;

      --green-bg: linear-gradient(135deg, #dcfce7 0%, #86efac 100%);
      --green-br: rgba(22,163,74,0.35);
      --green-brD:#166534;

      --yellow-bg: linear-gradient(135deg, #fef3c7 0%, #fcd34d 100%);
      --yellow-br: rgba(245,158,11,0.45);
      --yellow-brD:#b45309;

      --blue-bg: linear-gradient(135deg, #dbeafe 0%, #93c5fd 100%);
      --blue-br: rgba(37,99,235,0.35);
      --blue-brD:#1d4ed8;

      --pink-bg: linear-gradient(135deg, #fce7f3 0%, #f9a8d4 100%);
      --pink-br: rgba(219,39,119,0.35);
      --pink-brD:#9d174d;

      --card: rgba(255,255,255,0.82);
      --cardLine: rgba(15,23,42,0.10);

      --ok:#16a34a;
      --bad:#dc2626;
    }

    body{
      margin:0;
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:14px;
      color:var(--text);
      background:
        radial-gradient(900px 600px at 10% 20%, var(--bg1) 0%, transparent 60%),
        radial-gradient(900px 600px at 90% 30%, var(--bg2) 0%, transparent 60%),
        radial-gradient(900px 600px at 60% 90%, var(--bg3) 0%, transparent 60%),
        linear-gradient(135deg, #f8fafc 0%, var(--bg4) 50%, #fdf2f8 100%);
    }

    .app{
      width:min(980px, 100%);
      background: rgba(255,255,255,0.70);
      border:2px solid rgba(255,255,255,0.65);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      border-radius:22px;
      box-shadow:var(--shadow);
      padding:16px 18px;
      box-sizing:border-box;
    }
    @media (min-width: 820px){ .app{ padding:18px 22px; } }

    .topbar{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin-bottom:10px;
    }
    .titleWrap{ display:flex; align-items:center; gap:10px; }
    h1{ margin:0; font-size:1.35rem; font-weight:1100; letter-spacing:0.2px; }
    .mini{ font-size:0.95rem; color:var(--muted); font-weight:1000; white-space:nowrap; }

    .infoBtn{
      width:42px; height:42px; border-radius:999px;
      border:2px solid rgba(37,99,235,0.25);
      background: rgba(37,99,235,0.12);
      color: #2563eb;
      font-weight:1100; font-size:1.15rem;
      cursor:pointer;
      display:grid; place-items:center;
      user-select:none; touch-action: manipulation;
      transition: transform 0.05s ease, background 0.15s ease;
    }
    .infoBtn:active{ transform: translateY(1px); }
    .infoBtn.on{ background: rgba(37,99,235,0.20); border-color: rgba(37,99,235,0.35); }

    .help{ margin:6px 0 12px; color:var(--muted); font-size:0.98rem; line-height:1.25; }
    .hidden{ display:none !important; }

    .grid{ display:grid; gap:10px; }
    .grid.two{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
    .grid.three{ grid-template-columns: repeat(3, minmax(0, 1fr)); }
    @media (max-width: 640px){ .grid.two, .grid.three{ grid-template-columns: 1fr; } }

    .card{
      border:2px solid var(--cardLine);
      border-radius:20px;
      padding:12px;
      background: var(--card);
    }

    .btn{
      border:3px solid rgba(15,23,42,0.10);
      border-radius:18px;
      padding:12px 10px;
      font-size:1.05rem;
      font-weight:1100;
      cursor:pointer;
      user-select:none;
      touch-action: manipulation;
      transition: transform 0.05s ease, filter 0.15s ease, box-shadow 0.15s ease;
      box-shadow: 0 10px 18px rgba(2,6,23,0.08);
      color: var(--text);
    }
    .btn:active{ transform: translateY(1px); }
    .btn:hover{ filter: brightness(0.98) saturate(1.05); }

    .btn.selected{
      outline: 3px solid rgba(255,255,255,0.55);
      box-shadow: 0 16px 28px rgba(2,6,23,0.12);
    }
    .btn[data-tone="teal"].selected{ border-color: var(--teal-brD); }
    .btn[data-tone="purple"].selected{ border-color: var(--purple-brD); }
    .btn[data-tone="green"].selected{ border-color: var(--green-brD); }
    .btn[data-tone="yellow"].selected{ border-color: var(--yellow-brD); }
    .btn[data-tone="blue"].selected{ border-color: var(--blue-brD); }
    .btn[data-tone="pink"].selected{ border-color: var(--pink-brD); }

    .btn[data-tone="teal"]{ border-color: var(--teal-br); background: var(--teal-bg); }
    .btn[data-tone="purple"]{ border-color: var(--purple-br); background: var(--purple-bg); }
    .btn[data-tone="green"]{ border-color: var(--green-br); background: var(--green-bg); }
    .btn[data-tone="yellow"]{ border-color: var(--yellow-br); background: var(--yellow-bg); }
    .btn[data-tone="blue"]{ border-color: var(--blue-br); background: var(--blue-bg); }
    .btn[data-tone="pink"]{ border-color: var(--pink-br); background: var(--pink-bg); }

    .primary{
      width:100%;
      border:none;
      border-radius:999px;
      padding:12px 14px;
      font-size:1.18rem;
      font-weight:1200;
      color:white;
      background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
      box-shadow: 0 18px 30px rgba(37,99,235,0.22);
    }
    .primary:disabled{ opacity:0.55; cursor:not-allowed; box-shadow:none; }
    .ghost{
      width:100%;
      border-radius:999px;
      padding:11px 14px;
      font-weight:1100;
      background: rgba(255,255,255,0.75);
      box-shadow:none;
    }

    .rowNote{
      text-align:center;
      font-weight:1100;
      color:var(--muted);
      min-height:1.2rem;
      margin-top:6px;
    }

    /* Timer buttons (icons only) */
    .pillrow{ display:flex; flex-wrap:wrap; gap:10px; }
    .pill{
      display:inline-flex;
      gap:10px;
      align-items:center;
      border:2px solid rgba(15,23,42,0.10);
      background: rgba(255,255,255,0.82);
      border-radius:999px;
      padding:11px 14px;
      cursor:pointer;
      font-weight:1200;
      user-select:none;
      touch-action: manipulation;
      box-shadow: 0 10px 18px rgba(2,6,23,0.06);
      font-size:1.05rem;
    }
    .pill.selected{
      border-color: rgba(14,165,233,0.35);
      background: rgba(14,165,233,0.14);
    }
    .icon{
      width:26px; height:26px;
      display:inline-grid; place-items:center;
      border-radius:999px;
      background: rgba(15,23,42,0.08);
      font-size:15px;
    }
    .bolt{ font-size:16px; line-height:1; }

    .quiz-layout{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
    }
    @media (min-width: 820px){
      .quiz-layout{ grid-template-columns: 1.05fr 0.95fr; align-items:start; }
    }

    .tag{
      display:inline-block;
      border-radius:999px;
      padding:4px 10px;
      font-size:0.92rem;
      font-weight:1200;
      background: rgba(37,99,235,0.12);
      color: #1d4ed8;
    }

    .equation{
      font-size: clamp(2.4rem, 4.2vw, 3.2rem);
      font-weight:1300;
      text-align:center;
      margin:10px 0 4px;
      letter-spacing: 0.5px;
    }

    .timerWrap{
      margin-top:8px;
      height:16px;
      background: rgba(15,23,42,0.08);
      border-radius:999px;
      overflow:hidden;
      border:2px solid rgba(15,23,42,0.10);
    }
    .timerBar{
      height:100%;
      width:100%;
      border-radius:999px;
      transition: width 0.08s linear;
    }

    .options{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap:10px;
      margin-top:10px;
    }
    .opt{
      border:3px solid rgba(15,23,42,0.10);
      background: rgba(255,255,255,0.75);
      border-radius:18px;
      padding:14px 10px;
      font-size:1.45rem;
      font-weight:1300;
      cursor:pointer;
      user-select:none;
      touch-action: manipulation;
      box-shadow: 0 10px 18px rgba(2,6,23,0.06);
      transition: transform 0.05s ease, filter 0.15s ease;
    }
    .opt:hover{ filter: brightness(0.98) saturate(1.05); }
    .opt:active{ transform: translateY(1px); }

    .feedback{
      min-height:1.4rem;
      text-align:center;
      font-weight:1300;
      margin-top:8px;
      font-size:1.08rem;
    }
    .feedback.ok{ color:var(--ok); }
    .feedback.bad{ color:var(--bad); }

    .scoreWrap{ margin-top:10px; }
    .scoreTitle{
      display:flex; justify-content:space-between; align-items:center;
      font-weight:1200; color:var(--muted); font-size:0.95rem;
      margin-bottom:6px;
    }
    .scale{
      position:relative;
      height:16px;
      border-radius:999px;
      border:2px solid rgba(15,23,42,0.10);
      background: linear-gradient(90deg, rgba(220,38,38,0.16) 0%, rgba(15,23,42,0.06) 50%, rgba(22,163,74,0.18) 100%);
      overflow:hidden;
    }
    .midline{
      position:absolute;
      left:50%; top:0; width:3px; height:100%;
      background: rgba(100,116,139,0.8);
      transform: translateX(-50%);
    }
    .dot{
      position:absolute;
      top:50%;
      width:18px; height:18px;
      border-radius:999px;
      background:#0f172a;
      transform: translate(-50%, -50%);
      box-shadow: 0 10px 18px rgba(2,6,23,0.18);
      border:2px solid rgba(255,255,255,0.9);
    }
    .scaleLabels{
      display:flex; justify-content:space-between;
      font-size:0.9rem; color:var(--muted); font-weight:1200;
      margin-top:6px;
    }

    .scoreboard{
      display:flex;
      gap:10px;
      align-items:stretch;
      justify-content:space-between;
      margin-top:10px;
    }
    .scoreBox{
      flex:1;
      border:2px solid rgba(15,23,42,0.10);
      background: rgba(255,255,255,0.75);
      border-radius:18px;
      padding:10px;
      text-align:center;
      box-shadow: 0 10px 18px rgba(2,6,23,0.06);
    }
    .scoreBox .label{ color:var(--muted); font-weight:1200; font-size:0.95rem; }
    .scoreBox .num{ font-size:2.05rem; font-weight:1400; margin-top:2px; }

    .answerLine{
      display:flex;
      gap:10px;
      align-items:stretch;
      margin-top:10px;
    }
    .answerDisplay{
      flex:1;
      border:2px solid rgba(15,23,42,0.10);
      border-radius:18px;
      background: rgba(255,255,255,0.75);
      padding:12px;
      font-size:1.7rem;
      font-weight:1400;
      text-align:center;
      letter-spacing:2px;
      user-select:none;
      min-height:52px;
      display:flex;
      align-items:center;
      justify-content:center;
      box-shadow: 0 10px 18px rgba(2,6,23,0.06);
    }
    .submitBtn{
      width:130px;
      border:none;
      border-radius:18px;
      background: linear-gradient(135deg, #16a34a 0%, #15803d 100%);
      color:white;
      font-weight:1400;
      font-size:1.12rem;
      cursor:pointer;
      user-select:none;
      touch-action: manipulation;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      box-shadow: 0 16px 26px rgba(21,128,61,0.22);
      transition: transform 0.05s ease, opacity 0.15s ease;
    }
    .submitBtn:active{ transform: translateY(1px); }
    .submitBtn:disabled{ opacity:0.55; cursor:not-allowed; box-shadow:none; }
    .submitIcon{
      width:22px; height:22px;
      border-radius:999px;
      background: rgba(255,255,255,0.25);
      display:grid; place-items:center;
      font-size:14px;
    }
    .keypad{
      margin-top:10px;
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap:10px;
    }
    .key{
      border:2px solid rgba(15,23,42,0.10);
      background: rgba(255,255,255,0.75);
      border-radius:18px;
      padding:14px 10px;
      font-size:1.6rem;
      font-weight:1400;
      cursor:pointer;
      user-select:none;
      touch-action: manipulation;
      box-shadow: 0 10px 18px rgba(2,6,23,0.06);
      transition: transform 0.05s ease;
    }
    .key:active{ transform: translateY(1px); }
    .key.small{ font-size:1.2rem; }

    .stars{
      display:inline-flex; gap:2px;
      margin-left:8px;
      vertical-align:middle;
    }
    .star{
      color:var(--star);
      text-shadow: 0 1px 0 rgba(0,0,0,0.15);
      font-size:1.05em;
      line-height:1;
    }
  </style>
</head>
<body>
<div class="app">
  <div class="topbar">
    <div class="titleWrap">
      <h1>Kopfrechnen</h1>
      <button class="infoBtn on" id="infoBtn" title="Info ein/aus">i</button>
    </div>
    <div class="mini" id="topMini">ZR 20 / ZR 100</div>
  </div>

  <div class="help" id="helpText">
    ZR20: rechnen &amp; erg√§nzen. ZR100: plus/minus &amp; erg√§nzen. (√ó/√∑ sind aus.)
  </div>

  <!-- START -->
  <div id="start">
    <div class="grid two">
      <div class="card">
        <div style="font-weight:1300; margin-bottom:8px;">Modus</div>
        <div class="grid two">
          <button class="btn modeBtn" data-tone="teal" data-mode="train">Training</button>
          <button class="btn modeBtn" data-tone="purple" data-mode="battle">Wettkampf</button>
        </div>

        <div id="battleSettings" class="hidden" style="margin-top:10px;">
          <div style="font-weight:1300; margin-bottom:8px;">Spiel</div>
          <div class="grid three">
            <button class="btn matchBtn" data-tone="yellow" data-match="5">Kurz</button>
            <button class="btn matchBtn" data-tone="pink" data-match="7">Mittel</button>
            <button class="btn matchBtn" data-tone="blue" data-match="9">Lang</button>
          </div>
        </div>
      </div>

      <div class="card">
        <div style="font-weight:1300; margin-bottom:8px;">Zeit</div>
        <div class="pillrow" id="timeRow">
          <div class="pill timeBtn" data-time="5"  title="Sehr schnell (5s)"><span class="icon">‚è±Ô∏è</span><span class="bolt">‚ö°‚ö°‚ö°</span></div>
          <div class="pill timeBtn" data-time="7.5" title="Schnell (7.5s)"><span class="icon">‚è±Ô∏è</span><span class="bolt">‚ö°‚ö°</span></div>
          <div class="pill timeBtn" data-time="10" title="Mittel (10s)"><span class="icon">‚è±Ô∏è</span><span class="bolt">‚ö°</span></div>
          <div class="pill timeBtn" data-time="15" title="Normal (15s)"><span class="icon">‚è±Ô∏è</span></div>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:10px;">
      <div style="font-weight:1300; margin-bottom:8px;">Zahlenraum</div>
      <div class="grid two">
        <button class="btn diffBtn" data-tone="green" data-diff="1">
          ZR 20 <span class="stars"><span class="star">‚òÖ</span></span>
        </button>
        <button class="btn diffBtn" data-tone="yellow" data-diff="2">
          ZR 20 <span class="stars"><span class="star">‚òÖ</span><span class="star">‚òÖ</span></span>
        </button>
        <button class="btn diffBtn" data-tone="blue" data-diff="3">
          ZR 100 <span class="stars"><span class="star">‚òÖ</span><span class="star">‚òÖ</span><span class="star">‚òÖ</span></span>
        </button>
        <button class="btn diffBtn" data-tone="pink" data-diff="4">
          ZR 100 <span class="stars"><span class="star">‚òÖ</span><span class="star">‚òÖ</span><span class="star">‚òÖ</span><span class="star">‚òÖ</span></span>
        </button>
      </div>

      <div class="rowNote" id="startInfo">Bitte w√§hlen.</div>

      <button class="btn primary" id="startBtn" disabled>Los! üöÄ</button>
      <button class="btn ghost" id="resetBtn">Reset</button>
    </div>
  </div>

  <!-- QUIZ -->
  <div id="quiz" class="hidden">
    <div class="quiz-layout">

      <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
          <div class="tag" id="modeTag">‚Äî</div>
          <div class="mini" id="taskCounter">Aufgabe</div>
        </div>

        <div class="equation" id="eq">__</div>

        <div id="timerArea" class="hidden">
          <div class="timerWrap" aria-label="Zeitbalken">
            <div class="timerBar" id="timerBar"></div>
          </div>
        </div>

        <div id="mcArea" class="options hidden"></div>

        <div id="keypadArea" class="hidden">
          <div class="answerLine">
            <div class="answerDisplay" id="answerDisplay">‚Äî</div>
            <button class="submitBtn" id="submitBtn" disabled>
              <span class="submitIcon">‚úì</span> OK
            </button>
          </div>
          <div class="keypad" id="keypad"></div>
        </div>

        <div class="feedback" id="fb"></div>

        <div style="display:flex; gap:10px; margin-top:10px;">
          <button class="btn ghost" id="quitBtn">Men√º</button>
        </div>
      </div>

      <div class="card">
        <div style="font-weight:1300;">Anzeige</div>

        <div class="scoreboard hidden" id="battleBoard">
          <div class="scoreBox">
            <div class="label">DU</div>
            <div class="num" id="roundsYou">0</div>
          </div>
          <div class="scoreBox">
            <div class="label">RUNDE</div>
            <div class="num" id="roundNo">1</div>
          </div>
          <div class="scoreBox">
            <div class="label">PC</div>
            <div class="num" id="roundsPc">0</div>
          </div>
        </div>

        <div class="scoreWrap">
          <div class="scoreTitle">
            <span>Punkte</span>
            <span id="scoreText">0</span>
          </div>
          <div class="scale">
            <div class="midline"></div>
            <div class="dot" id="scoreDot" style="left:50%;"></div>
          </div>
          <div class="scaleLabels">
            <span>-5</span><span>0</span><span>+5</span>
          </div>
        </div>

        <div class="card" style="margin-top:10px; background: rgba(255,255,255,0.55);">
          <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
            <div style="font-weight:1300;">Richtig</div>
            <div class="tag" id="diffTag">‚Äî</div>
          </div>
          <div style="margin-top:8px; font-weight:1300;">
            <span id="sRight">0</span> / <span id="sTotal">0</span>
          </div>
          <div style="margin-top:4px; color:var(--muted); font-weight:1200;">
            <span id="sPct">0%</span>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- RESULT -->
  <div id="result" class="hidden">
    <div class="card" style="text-align:center;">
      <h2 style="margin:0 0 6px;">Fertig! üéâ</h2>
      <p id="summary" style="margin:0; font-weight:1200;"></p>
      <p style="margin:10px 0 0; color:var(--muted); font-weight:1100;">
        <strong><span id="summaryPct">0%</span></strong>
      </p>

      <div style="margin-top:12px;" class="grid two">
        <button class="btn primary" id="playAgainBtn">Nochmal</button>
        <button class="btn ghost" id="backBtn">Men√º</button>
      </div>
    </div>
  </div>
</div>

<script>
/* =========================
   Audio
   ========================= */
const AUDIO = {
  correct: new Audio('audio/correct.wav'),
  error: new Audio('audio/error.wav'),
  roundwon: new Audio('audio/roundwon.wav'),
  roundlost: new Audio('audio/roundlost.wav'),
  gamewon: new Audio('audio/gamewon.wav'),
  gamelost: new Audio('audio/gamelost.wav'),
};
function playSound(key){
  const a = AUDIO[key];
  if(!a) return;
  try{ a.currentTime=0; a.play().catch(()=>{}); }catch(e){}
}

/* =========================
   State
   ========================= */
let mode = null;            // 'train' | 'battle'
let matchBestOf = 5;        // 5|7|9
let answerTime = 10;        // 5|7.5|10|15
let diff = null;            // 1..4

let totalTasks = 0;
let correctCount = 0;

let current = null;         // {text, correct, answerType, options?}
let locked = false;

let timerOn = false;
let timerId = null;
let timerStart = 0;
let timerLimitMs = 0;

let score = 0;
let roundsYou = 0;
let roundsPc = 0;
let roundNo = 1;

const TRAIN_TOTAL = 20;

/* =========================
   DOM
   ========================= */
const startEl = document.getElementById('start');
const quizEl = document.getElementById('quiz');
const resultEl = document.getElementById('result');

const startInfo = document.getElementById('startInfo');
const startBtn = document.getElementById('startBtn');
const resetBtn = document.getElementById('resetBtn');
const battleSettings = document.getElementById('battleSettings');

const modeTag = document.getElementById('modeTag');
const diffTag = document.getElementById('diffTag');
const taskCounter = document.getElementById('taskCounter');
const eq = document.getElementById('eq');

const timerArea = document.getElementById('timerArea');
const timerBar = document.getElementById('timerBar');

const mcArea = document.getElementById('mcArea');
const keypadArea = document.getElementById('keypadArea');
const keypad = document.getElementById('keypad');
const answerDisplay = document.getElementById('answerDisplay');
const submitBtn = document.getElementById('submitBtn');

const fb = document.getElementById('fb');
const quitBtn = document.getElementById('quitBtn');

const battleBoard = document.getElementById('battleBoard');
const roundsYouEl = document.getElementById('roundsYou');
const roundsPcEl = document.getElementById('roundsPc');
const roundNoEl = document.getElementById('roundNo');

const scoreText = document.getElementById('scoreText');
const scoreDot = document.getElementById('scoreDot');

const sRight = document.getElementById('sRight');
const sTotal = document.getElementById('sTotal');
const sPct = document.getElementById('sPct');

const summary = document.getElementById('summary');
const summaryPct = document.getElementById('summaryPct');
const playAgainBtn = document.getElementById('playAgainBtn');
const backBtn = document.getElementById('backBtn');

/* Info toggle */
const infoBtn = document.getElementById('infoBtn');
const helpText = document.getElementById('helpText');
let showHelp = true;
infoBtn.addEventListener('click', ()=>{
  showHelp = !showHelp;
  helpText.classList.toggle('hidden', !showHelp);
  infoBtn.classList.toggle('on', showHelp);
});

/* =========================
   Start selection handlers
   ========================= */
function setSelected(groupSelector, selectedEl){
  document.querySelectorAll(groupSelector).forEach(el => el.classList.remove('selected'));
  if(selectedEl) selectedEl.classList.add('selected');
}

document.querySelectorAll('.modeBtn').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    mode = btn.dataset.mode;
    setSelected('.modeBtn', btn);
    battleSettings.classList.toggle('hidden', mode !== 'battle');
    updateStartReady();
  });
});

document.querySelectorAll('.matchBtn').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    matchBestOf = parseInt(btn.dataset.match, 10);
    setSelected('.matchBtn', btn);
    updateStartReady();
  });
});

document.querySelectorAll('.timeBtn').forEach(pill=>{
  pill.addEventListener('click', ()=>{
    answerTime = parseFloat(pill.dataset.time);
    document.querySelectorAll('.timeBtn').forEach(x=>x.classList.remove('selected'));
    pill.classList.add('selected');
    updateStartReady();
  });
});

document.querySelectorAll('.diffBtn').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    diff = parseInt(btn.dataset.diff, 10);
    setSelected('.diffBtn', btn);
    updateStartReady();
  });
});

resetBtn.addEventListener('click', ()=>{
  mode = null; diff = null; answerTime = 10; matchBestOf = 5;
  document.querySelectorAll('.modeBtn,.matchBtn,.timeBtn,.diffBtn').forEach(x=>x.classList.remove('selected'));
  // default time: 10s (‚ö°)
  document.querySelectorAll('.timeBtn').forEach(x=>{
    if(parseFloat(x.dataset.time)===10) x.classList.add('selected');
  });
  battleSettings.classList.add('hidden');
  updateStartReady();
});

/* Default: 10s selected */
(function init(){
  document.querySelectorAll('.timeBtn').forEach(x=>{
    if(parseFloat(x.dataset.time)===10) x.classList.add('selected');
  });
  buildKeypad();
  setScoreDot(0);
  updateStartReady();
})();

function updateStartReady(){
  let missing = [];
  if(!mode) missing.push("Modus");
  if(!diff) missing.push("ZR");
  if(missing.length){
    startInfo.textContent = "Bitte w√§hlen: " + missing.join(", ");
    startBtn.disabled = true;
    return;
  }
  startInfo.textContent = "Bereit!";
  startBtn.disabled = false;
}

/* =========================
   Navigation
   ========================= */
startBtn.addEventListener('click', startGame);
quitBtn.addEventListener('click', ()=>{
  stopTimer();
  showScreen('start');
});
playAgainBtn.addEventListener('click', ()=> showScreen('start'));
backBtn.addEventListener('click', ()=> showScreen('start'));

function showScreen(which){
  startEl.classList.toggle('hidden', which!=='start');
  quizEl.classList.toggle('hidden', which!=='quiz');
  resultEl.classList.toggle('hidden', which!=='result');
}

/* =========================
   Game flow
   ========================= */
function startGame(){
  correctCount = 0;
  totalTasks = 0;
  locked = false;
  fb.textContent = '';
  fb.className = 'feedback';

  if(mode === 'battle'){
    roundsYou = 0; roundsPc = 0; roundNo = 1; score = 0;
    battleBoard.classList.remove('hidden');
    roundsYouEl.textContent = '0';
    roundsPcEl.textContent = '0';
    roundNoEl.textContent = '1';
  } else {
    battleBoard.classList.add('hidden');
    score = 0;
  }

  updateStats();
  updateScoreUI();

  modeTag.textContent = (mode==='train') ? 'Training' : 'Wettkampf';
  diffTag.textContent =
    diff===1 ? 'ZR20 ‚òÖ' :
    diff===2 ? 'ZR20 ‚òÖ‚òÖ' :
    diff===3 ? 'ZR100 ‚òÖ‚òÖ‚òÖ' : 'ZR100 ‚òÖ‚òÖ‚òÖ‚òÖ';

  showScreen('quiz');
  nextTask();
}

function nextTask(){
  stopTimer();
  locked = false;
  fb.textContent = '';
  fb.className = 'feedback';

  if(mode === 'train' && totalTasks >= TRAIN_TOTAL){
    endSession();
    return;
  }

  current = generateTask(diff);
  eq.textContent = current.text;

  if(mode === 'train'){
    taskCounter.textContent = `Aufgabe ${totalTasks+1}/${TRAIN_TOTAL}`;
  } else {
    taskCounter.textContent = `Runde ${roundNo}`;
  }

  // ZR20: immer MC (damit Kinder nicht tippen m√ºssen)
  // ZR100: Keypad (direkte Eingabe)
  if(current.answerType === 'mc'){
    keypadArea.classList.add('hidden');
    mcArea.classList.remove('hidden');
    renderMC(current.options);
  } else {
    mcArea.classList.add('hidden');
    keypadArea.classList.remove('hidden');
    resetAnswerInput();
  }

  if(mode === 'battle'){
    timerArea.classList.remove('hidden');
    startTimer(answerTime);
  } else {
    timerArea.classList.add('hidden');
  }
}

function endSession(finalSoundKey){
  stopTimer();
  if(finalSoundKey) playSound(finalSoundKey);

  const pct = totalTasks ? Math.round((correctCount/totalTasks)*100) : 0;
  summary.textContent = `${correctCount} / ${totalTasks}`;
  summaryPct.textContent = `${pct}%`;
  showScreen('result');
}

/* =========================
   Timer
   ========================= */
function startTimer(seconds){
  timerOn = true;
  timerStart = performance.now();
  timerLimitMs = seconds * 1000;

  timerBar.style.width = '100%';
  timerBar.style.background = '#16a34a';
  timerId = requestAnimationFrame(tickTimer);
}
function tickTimer(now){
  if(!timerOn) return;
  const elapsed = now - timerStart;
  const left = Math.max(0, timerLimitMs - elapsed);
  const ratio = left / timerLimitMs;

  timerBar.style.width = (ratio*100).toFixed(1) + '%';

  if(ratio > 0.55) timerBar.style.background = '#16a34a';
  else if(ratio > 0.25) timerBar.style.background = '#f59e0b';
  else timerBar.style.background = '#dc2626';

  if(left <= 0){
    timerOn = false;
    onAnswer(null, {timeout:true});
    return;
  }
  timerId = requestAnimationFrame(tickTimer);
}
function stopTimer(){
  timerOn = false;
  if(timerId){
    cancelAnimationFrame(timerId);
    timerId = null;
  }
}

/* =========================
   Answer handling
   ========================= */
function onAnswer(value, meta={}){
  if(locked) return;
  locked = true;
  stopTimer();

  totalTasks++;
  const isCorrect = (value !== null && value === current.correct);

  if(isCorrect){
    correctCount++;
    fb.textContent = 'Richtig!';
    fb.className = 'feedback ok';
    playSound('correct');
  } else {
    fb.textContent = meta.timeout ? 'Zeit!' : 'Falsch!';
    fb.className = 'feedback bad';
    playSound('error');
  }

  updateStats();

  if(mode === 'battle'){
    score += isCorrect ? 1 : -1;
    score = clamp(score, -5, 5);
    updateScoreUI();

    if(score >= 5){
      roundsYou++;
      roundsYouEl.textContent = String(roundsYou);
      playSound('roundwon');
      if(isMatchFinished()){
        playSound('gamewon');
        setTimeout(()=>endSession(), 520);
        return;
      }
      roundNo++;
      roundNoEl.textContent = String(roundNo);
      score = 0;
      updateScoreUI();
    } else if(score <= -5){
      roundsPc++;
      roundsPcEl.textContent = String(roundsPc);
      playSound('roundlost');
      if(isMatchFinished()){
        playSound('gamelost');
        setTimeout(()=>endSession(), 520);
        return;
      }
      roundNo++;
      roundNoEl.textContent = String(roundNo);
      score = 0;
      updateScoreUI();
    }
  }

  setTimeout(()=> nextTask(), 420);
}
function isMatchFinished(){
  const need = Math.floor(matchBestOf/2) + 1;
  return (roundsYou >= need || roundsPc >= need);
}

/* =========================
   MC rendering
   ========================= */
function renderMC(options){
  mcArea.innerHTML = '';
  options.forEach(v=>{
    const b = document.createElement('button');
    b.className = 'opt';
    b.type = 'button';
    b.textContent = String(v);
    b.addEventListener('click', ()=> onAnswer(v));
    mcArea.appendChild(b);
  });
}

/* =========================
   Keypad
   ========================= */
let typed = '';
function buildKeypad(){
  const keys = ['1','2','3','4','5','6','7','8','9','‚å´','0','C'];
  keypad.innerHTML = '';
  keys.forEach(k=>{
    const b = document.createElement('button');
    b.type = 'button';
    b.className = 'key' + ((k==='‚å´'||k==='C') ? ' small' : '');
    b.textContent = k;
    b.addEventListener('click', ()=>pressKey(k));
    keypad.appendChild(b);
  });
}
function resetAnswerInput(){
  typed = '';
  answerDisplay.textContent = '‚Äî';
  submitBtn.disabled = true;
}
function pressKey(k){
  if(locked) return;
  if(k === 'C'){
    typed = '';
  } else if(k === '‚å´'){
    typed = typed.slice(0, -1);
  } else {
    if(typed.length >= 3) return;
    if(typed === '0') typed = '';
    typed += k;
  }
  answerDisplay.textContent = typed.length ? typed : '‚Äî';
  submitBtn.disabled = (typed.length === 0);
}
submitBtn.addEventListener('click', ()=>{
  if(typed.length === 0) return;
  onAnswer(parseInt(typed, 10));
});

/* =========================
   Generator (NEU nach Vorgabe)
   ZR20:
     ‚òÖ   = normale Aufgaben: a+b=?  /  a-b=?
     ‚òÖ‚òÖ  = Umkehrrechnung/Erg√§nzen: a+?=c  /  ?-a=b  /  ?+a=c  /  c-?=a
   ZR100:
     ‚òÖ‚òÖ‚òÖ = +/‚àí & Erg√§nzen; nur wenn Ergebnis > 50 darf ein 10er vorkommen
     ‚òÖ‚òÖ‚òÖ‚òÖ= +/‚àí & Erg√§nzen; frei bis 100
   Multiplikation/Division in ZR100: gestrichen.
   ========================= */
function generateTask(d){
  if(d === 1) return genZR20NormalMC();
  if(d === 2) return genZR20MissingMC();
  if(d === 3) return genZR100MissingKeypad(true);
  return genZR100MissingKeypad(false);
}

/* ---------- ZR20 ‚òÖ: normal rechnen, Antwort abfragen ---------- */
function genZR20NormalMC(){
  const isSub = Math.random() < 0.5;
  let a,b,correct,text;

  if(isSub){
    a = randInt(0,20);
    b = randInt(0,a);
    correct = a - b;
    text = `${a} ‚àí ${b} = ?`;
  } else {
    a = randInt(0,20);
    b = randInt(0,20);
    if(a+b > 20){ b = 20 - a; }
    correct = a + b;
    text = `${a} + ${b} = ?`;
  }

  return {text, correct, answerType:'mc', options: makeMCOptions(correct, 4, 0, 20)};
}

/* ---------- ZR20 ‚òÖ‚òÖ: Erg√§nzen/Umkehrrechnung (MC) ---------- */
function genZR20MissingMC(){
  // Formen:
  // 1) a + ? = c
  // 2) ? + a = c
  // 3) ? ‚àí a = b
  // 4) c ‚àí ? = a
  const form = randInt(1,4);
  let a,b,c,correct,text;

  if(form === 1){
    a = randInt(0,20);
    c = randInt(a,20);
    correct = c - a;
    text = `${a} + ? = ${c}`;
  } else if(form === 2){
    a = randInt(0,20);
    c = randInt(a,20);
    correct = c - a;
    text = `? + ${a} = ${c}`;
  } else if(form === 3){
    // ? - a = b  => ? = a+b
    a = randInt(0,20);
    b = randInt(0,20);
    if(a+b > 20){ b = 20 - a; }
    correct = a + b;
    text = `? ‚àí ${a} = ${b}`;
  } else {
    // c - ? = a  => ? = c-a
    c = randInt(0,20);
    a = randInt(0,c);
    correct = c - a;
    text = `${c} ‚àí ? = ${a}`;
  }

  return {text, correct, answerType:'mc', options: makeMCOptions(correct, 4, 0, 20)};
}

/* ---------- ZR100 ‚òÖ‚òÖ‚òÖ/‚òÖ‚òÖ‚òÖ‚òÖ: +/‚àí & Erg√§nzen (Keypad) ---------- */
/* tensRule=true: nur wenn Ergebnis > 50 darf ein 10er vorkommen (bei den gegebenen Zahlen) */
function genZR100MissingKeypad(tensRule){
  // Formen:
  // A) x + ? = y
  // B) ? + x = y
  // C) ? ‚àí x = y
  // D) y ‚àí ? = x
  // E) x + y = ?
  // F) x ‚àí y = ?
  const forms = ['A','B','C','D','E','F'];
  const form = forms[randInt(0, forms.length-1)];

  let x,y,correct,text;

  if(form === 'A'){ // x + ? = y
    y = randInt(0,100);
    x = randInt(0,y);
    correct = y - x;
    text = `${x} + ? = ${y}`;
  } else if(form === 'B'){ // ? + x = y
    y = randInt(0,100);
    x = randInt(0,y);
    correct = y - x;
    text = `? + ${x} = ${y}`;
  } else if(form === 'C'){ // ? - x = y => ? = x+y
    x = randInt(0,100);
    y = randInt(0,100 - x);
    correct = x + y;
    text = `? ‚àí ${x} = ${y}`;
  } else if(form === 'D'){ // y - ? = x => ? = y-x
    y = randInt(0,100);
    x = randInt(0,y);
    correct = y - x;
    text = `${y} ‚àí ? = ${x}`;
  } else if(form === 'E'){ // x + y = ?
    x = randInt(0,100);
    y = randInt(0,100 - x);
    correct = x + y;
    text = `${x} + ${y} = ?`;
  } else { // F: x - y = ?
    x = randInt(0,100);
    y = randInt(0,x);
    correct = x - y;
    text = `${x} ‚àí ${y} = ?`;
  }

  // Regel f√ºr ‚òÖ‚òÖ‚òÖ: nur wenn correct > 50 darf ein 10er vorkommen
  if(tensRule){
    const triesMax = 500;
    let tries = 0;

    while(tries < triesMax){
      tries++;

      // pr√ºfen ob in x/y ein Zehner vorkommt (Vielfaches von 10, au√üer 0)
      const hasTens = (n)=> (n !== 0 && n % 10 === 0);
      const tensPresent =
        (typeof x === 'number' && hasTens(x)) ||
        (typeof y === 'number' && hasTens(y));

      if(correct > 50){
        // 10er sind ok
        break;
      } else {
        // correct <= 50: keine 10er in den sichtbaren Zahlen
        if(!tensPresent) break;
      }

      // neu w√ºrfeln
      // (einfach: neue Aufgabe generieren, bis Regel passt)
      const regen = genZR100MissingKeypad(false); // erst mal frei generieren
      // regen liefert Keypad-Aufgabe; wir √ºbernehmen x/y/correct/text aus dem generierten Ausdruck,
      // aber wir brauchen x/y numerisch. -> darum: direkt neu erzeugen mit gleicher Logik:
      // => wir rufen uns selbst rekursiv NICHT (wegen Stack), sondern machen schnelle Neu-Generierung:
      const tmp = genZR100MissingKeypad_raw();
      x = tmp.x; y = tmp.y; correct = tmp.correct; text = tmp.text;
    }
  }

  return {text, correct, answerType:'keypad'};
}

/* Helper: rohe Generierung wie oben, aber gibt x/y zur√ºck (f√ºr tensRule Loop) */
function genZR100MissingKeypad_raw(){
  const forms = ['A','B','C','D','E','F'];
  const form = forms[randInt(0, forms.length-1)];

  let x,y,correct,text;

  if(form === 'A'){ y = randInt(0,100); x = randInt(0,y); correct = y - x; text = `${x} + ? = ${y}`; }
  else if(form === 'B'){ y = randInt(0,100); x = randInt(0,y); correct = y - x; text = `? + ${x} = ${y}`; }
  else if(form === 'C'){ x = randInt(0,100); y = randInt(0,100 - x); correct = x + y; text = `? ‚àí ${x} = ${y}`; }
  else if(form === 'D'){ y = randInt(0,100); x = randInt(0,y); correct = y - x; text = `${y} ‚àí ? = ${x}`; }
  else if(form === 'E'){ x = randInt(0,100); y = randInt(0,100 - x); correct = x + y; text = `${x} + ${y} = ?`; }
  else { x = randInt(0,100); y = randInt(0,x); correct = x - y; text = `${x} ‚àí ${y} = ?`; }

  return {x,y,correct,text};
}

/* =========================
   Options helper
   ========================= */
function makeMCOptions(correct, count, minV, maxV){
  const set = new Set([correct]);
  const candidates = [];
  [1,2,3,4,5,10].forEach(d=>{ candidates.push(correct + d, correct - d); });
  for(let i=0;i<20;i++){
    const off = randInt(-12,12);
    if(off!==0) candidates.push(correct + off);
  }

  let guard = 0;
  while(set.size < count && guard < 400){
    guard++;
    let c;
    if(Math.random() < 0.75 && candidates.length){
      c = candidates[randInt(0, candidates.length-1)];
    } else {
      c = randInt(minV, maxV);
    }
    if(c < minV || c > maxV) continue;
    set.add(c);
  }

  const arr = Array.from(set);
  for(let i=arr.length-1;i>0;i--){
    const j = randInt(0,i);
    [arr[i],arr[j]] = [arr[j],arr[i]];
  }
  return arr;
}

/* =========================
   UI helpers
   ========================= */
function updateStats(){
  sRight.textContent = String(correctCount);
  sTotal.textContent = String(totalTasks);
  const pct = totalTasks ? Math.round((correctCount/totalTasks)*100) : 0;
  sPct.textContent = pct + '%';
}
function updateScoreUI(){
  scoreText.textContent = String(score);
  setScoreDot(score);
}
function setScoreDot(scoreVal){
  const clamped = clamp(scoreVal, -5, 5);
  const pct = ((clamped + 5) / 10) * 100;
  scoreDot.style.left = pct + '%';
}
function clamp(x, a, b){ return Math.max(a, Math.min(b, x)); }
function randInt(min, max){ return Math.floor(Math.random()*(max-min+1))+min; }
</script>
</body>
</html>
